<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Migration - Mitratel Non-Tower Asset</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        mitratel: {
                            red: '#EE2E24',      // Mitratel Red
                            dark: '#111827',     // Deep Charcoal
                            gray: '#F3F4F6',     // Light Gray
                            hover: '#C91E17'     // Darker Red for hover
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'glow': '0 0 15px rgba(238, 46, 36, 0.3)'
                    },
                    animation: {
                        'bounce-short': 'bounce 1s infinite 2',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <!-- SheetJS for Excel Processing -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Styles */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #EE2E24;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Updated Viz Container for Zoom/Pan */
        #viz-scroll-container {
            overflow: scroll;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            cursor: grab;
            position: relative;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Dark mode override for scroll container */
        .dark #viz-scroll-container {
            background-color: #111827;
            background-image: radial-gradient(#374151 1px, transparent 1px);
        }

        #viz-scroll-container:active {
            cursor: grabbing;
        }
        
        /* SVG Styles */
        text { font-family: 'Inter', sans-serif; }
        .pid-box { fill: #ffffff; stroke: #15803d; stroke-width: 1px; rx: 6; }
        .cable-box { fill: #ffffff; stroke: #EE2E24; stroke-width: 1px; rx: 4; }
        .dark .pid-box { fill: #1f2937; stroke: #22c55e; }
        .dark .cable-box { fill: #1f2937; stroke: #ef4444; }
        
        /* Highlight Styles */
        .highlight-pid-box { fill: #FEF2F2 !important; stroke: #EE2E24 !important; stroke-width: 2px !important; } 
        .dark .highlight-pid-box { fill: #450a0a !important; stroke: #ef4444 !important; }
        .highlight-pid-text { fill: #EE2E24 !important; font-weight: 800 !important; font-size: 11px !important; text-decoration: underline; }
        .dark .highlight-pid-text { fill: #fca5a5 !important; }
        .row-highlight { background-color: #FEF2F2 !important; }
        .dark .row-highlight { background-color: #450a0a !important; color: white !important; }

        /* Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Table Sticky Header */
        th.sticky-header { position: sticky; top: 0; background: #f9fafb; z-index: 10; backdrop-filter: blur(4px); background-color: rgba(249, 250, 251, 0.9); }
        .dark th.sticky-header { background-color: rgba(17, 24, 39, 0.9); color: #e5e7eb; }

        /* --- Converter styles (embedded) --- */
        .drop-zone {
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23D1D5DBFF' stroke-width='2' stroke-dasharray='8%2c 8' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .dark .drop-zone {
             background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%234B5563FF' stroke-width='2' stroke-dasharray='8%2c 8' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .drop-zone.dragover {
            background-color: #FEF2F2;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23EE2E24FF' stroke-width='2' stroke-dasharray='8%2c 8' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .dark .drop-zone.dragover {
             background-color: #374151;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Top tabs */
        .nav-btn { position: relative; overflow: hidden; }
        .nav-btn::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0%; height: 2px; background-color: #EE2E24; transition: width 0.3s; }
        .nav-btn:hover::after { width: 100%; }
        .nav-btn.active::after { width: 100%; }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* NEW: Force Status Badge Style */
        .status-badge-manual { border: 1px dashed currentColor; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 font-sans p-4 md:p-8 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-300" onclick="closeDropdowns(event)">

    <!-- Top Navigation / Branding -->
    <div class="max-w-7xl mx-auto mb-8">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
            
            <!-- Branding + Gamification Widget -->
            <div class="flex items-center gap-4 w-full md:w-auto">
                <!-- Mitratel Icon Style -->
                <div class="w-12 h-12 rounded-xl bg-white dark:bg-gray-800 shadow-soft flex items-center justify-center border border-gray-100 dark:border-gray-700 flex-shrink-0">
                    <i class="fa-solid fa-tower-broadcast text-2xl text-mitratel-red"></i>
                </div>
                <div class="flex flex-col">
                    <div class="font-bold text-2xl tracking-tight text-slate-900 dark:text-white leading-none">Mitratel</div>
                    <div class="text-xs font-semibold uppercase tracking-wider text-mitratel-red mt-1">Non-Tower Asset Management Unit</div>
                </div>
                
                <!-- Gamification Divider -->
                <div class="hidden md:block w-px h-10 bg-gray-200 dark:bg-gray-700 mx-2"></div>

                <!-- User Stats Widget (Gamification) -->
                <div class="hidden md:flex items-center gap-3 bg-white dark:bg-gray-800 px-3 py-1.5 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-gray-700 flex items-center justify-center text-xl overflow-hidden border-2 border-mitratel-red">
                            <i class="fa-solid fa-user-astronaut text-slate-600 dark:text-gray-300"></i>
                        </div>
                        <div class="absolute -bottom-1 -right-1 bg-mitratel-red text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white dark:border-gray-800" id="userLevel">Lvl 1</div>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-slate-800 dark:text-white" id="userRank">Intern Validator</div>
                        <div class="w-24 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full mt-1 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-orange-400 to-mitratel-red rounded-full transition-all duration-500" id="xpBar" style="width: 0%"></div>
                        </div>
                        <div class="text-[9px] text-gray-500 dark:text-gray-400 mt-0.5"><span id="userXp">0</span> XP</div>
                    </div>
                </div>
            </div>

            <!-- Global Controls -->
            <div class="flex items-center bg-white dark:bg-gray-800 p-1.5 rounded-2xl shadow-soft border border-gray-100 dark:border-gray-700">
                <!-- Tabs -->
                <button id="tabBtnValidator" class="px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 bg-gray-50 text-slate-900 shadow-sm dark:bg-gray-700 dark:text-white">
                    <i class="fa-solid fa-file-shield mr-2 text-mitratel-red"></i>Validator
                </button>
                <button id="tabBtnBatcher" class="px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 text-slate-500 hover:text-slate-900 dark:text-gray-400 dark:hover:text-white">
                    <i class="fa-solid fa-folder-tree mr-2"></i>Batcher
                </button>
                <button id="tabBtnConverter" class="px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 text-slate-500 hover:text-slate-900 dark:text-gray-400 dark:hover:text-white">
                    <i class="fa-solid fa-arrow-right-arrow-left mr-2"></i>Converter
                </button>
                
                <div class="w-px h-6 bg-gray-200 dark:bg-gray-600 mx-2"></div>

                <!-- Dark Mode Toggle -->
                <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-xl text-slate-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition flex items-center justify-center" title="Toggle Theme">
                    <i id="themeIcon" class="fa-regular fa-moon"></i>
                </button>
            </div>
        </div>
    </div>

<!-- TAB: VALIDATOR -->
<div id="tab-validator" class="fade-in">

    <div class="max-w-7xl mx-auto bg-white dark:bg-gray-900 shadow-xl shadow-gray-200/50 dark:shadow-none rounded-2xl p-6 md:p-8 relative border border-gray-100 dark:border-gray-800">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 pb-6 border-b border-gray-100 dark:border-gray-800 gap-4">
            <div>
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">SAP Migration Suite</h1>
                <p class="text-sm text-slate-500 dark:text-gray-400 mt-1 flex items-center gap-2">
                    <span class="bg-gray-100 dark:bg-gray-800 text-xs px-2 py-0.5 rounded text-gray-600 dark:text-gray-300 font-mono">v4.31 (Updated R20)</span>
                    Validation Rules
                </p>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                 <!-- CLEAR FILES BUTTON -->
                 <button id="btnClearFiles" onclick="clearValidatorQueue()" class="hidden px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition flex items-center">
                    <i class="fa-solid fa-trash mr-2"></i>Clear Queue
                </button>

                 <button id="btnStartValidation" onclick="startBatchValidation()" class="hidden bg-mitratel-red hover:bg-mitratel-hover text-white font-medium py-2 px-5 rounded-lg shadow-lg shadow-red-500/30 flex items-center transition transform hover:scale-[1.02] active:scale-95">
                    <i class="fa-solid fa-play mr-2 text-xs"></i>
                    Start Validation
                </button>
                
                <!-- Group Actions -->
                <div id="groupActions" class="hidden flex items-center gap-3">
                    <button id="btnDownloadReport" onclick="downloadSummaryReport()" class="bg-slate-800 hover:bg-slate-900 dark:bg-gray-700 dark:hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow flex items-center transition text-sm">
                        <i class="fa-solid fa-table mr-2"></i> Report
                    </button>

                    <!-- Batch Download Dropdown -->
                    <div class="relative inline-block text-left">
                        <button onclick="toggleBatchMenu(event)" class="bg-white border border-gray-200 dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 text-slate-700 dark:text-gray-200 font-medium py-2 px-4 rounded-lg shadow-sm flex items-center transition text-sm">
                            <i class="fa-solid fa-download mr-2 text-mitratel-red"></i>
                            Download
                            <i class="fa-solid fa-chevron-down ml-2 text-xs opacity-50"></i>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="batchMenu" class="hidden absolute right-0 mt-2 w-64 rounded-xl shadow-2xl bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-50 overflow-hidden">
                            <div class="py-2">
                                <div class="px-4 py-2 text-[10px] uppercase tracking-wider text-gray-400 dark:text-gray-500 font-bold">Batch Options</div>
                                <button onclick="downloadBatch('all')" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 flex justify-between items-center group">
                                    <span>Download All</span>
                                    <span id="badge-all" class="bg-gray-100 dark:bg-gray-700 group-hover:bg-white text-gray-600 dark:text-gray-300 text-xs px-2 py-0.5 rounded-md font-mono">0</span>
                                </button>
                                <button onclick="downloadBatch('pass')" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-green-50 dark:hover:bg-green-900/20 flex justify-between items-center group">
                                    <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>Pass Only</span>
                                    <span id="badge-pass" class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 text-xs px-2 py-0.5 rounded-md font-mono">0</span>
                                </button>
                                <button onclick="downloadBatch('fail')" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-red-50 dark:hover:bg-red-900/20 flex justify-between items-center group">
                                    <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span>Fail Only</span>
                                    <span id="badge-fail" class="bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 text-xs px-2 py-0.5 rounded-md font-mono">0</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- SAP TXT Export Dropdown -->
                    <div class="relative inline-block text-left">
                        <button onclick="toggleSapMenu(event)" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded-lg shadow-lg shadow-emerald-500/20 flex items-center transition text-sm">
                            <i class="fa-solid fa-file-code mr-2"></i>
                            SAP TXT
                            <i class="fa-solid fa-chevron-down ml-2 text-xs opacity-70"></i>
                        </button>
                        <div id="sapMenu" class="hidden absolute right-0 mt-2 w-72 rounded-xl shadow-2xl bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-50 overflow-hidden">
                             <div class="px-4 py-3 bg-gray-50 dark:bg-gray-800/50 border-b border-gray-100 dark:border-gray-700">
                                <p class="text-xs text-gray-500 dark:text-gray-400">Export SAP-ready text files (Tab-delimited).</p>
                            </div>
                            <div class="py-2">
                                <button onclick="downloadSapBatch('pass','separate')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 flex justify-between items-center">
                                    <span>PASS Only (Separate)</span>
                                    <span class="bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 text-xs px-2 py-0.5 rounded-md font-mono" id="badge-sap-pass">0</span>
                                </button>
                                <button onclick="downloadSapBatch('all','separate')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 flex justify-between items-center">
                                    <span>All Files (Separate)</span>
                                    <span class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2 py-0.5 rounded-md font-mono" id="badge-sap-all">0</span>
                                </button>
                                <div class="border-t border-gray-100 dark:border-gray-700 my-2"></div>
                                <div class="px-4 pb-2">
                                    <label class="text-[10px] uppercase font-bold text-gray-400 mb-1 block">Merge Output Filename</label>
                                    <input id="sapMergedFilename" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:outline-none dark:text-white" placeholder="SAP_MERGED.txt">
                                </div>
                                <button onclick="downloadSapBatch('pass','merge')" class="w-full text-left px-4 py-2 text-sm text-emerald-600 dark:text-emerald-400 font-medium hover:bg-emerald-50 dark:hover:bg-emerald-900/20">
                                    <i class="fa-solid fa-object-group mr-2"></i>Merge PASS Files
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="toggleGuide()" class="p-2 text-gray-400 hover:text-mitratel-red transition" title="Help">
                    <i class="fa-regular fa-circle-question text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Summary Dashboard -->
        <div id="summary-dashboard" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 hidden animate-fade-in">
            <!-- Total -->
            <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Total Processed</p>
                    <p class="text-3xl font-bold text-slate-800 dark:text-white mt-1" id="stat-total">0</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 flex items-center justify-center">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
            </div>
            <!-- Passed -->
            <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Passed</p>
                    <p class="text-3xl font-bold text-emerald-600 dark:text-emerald-400 mt-1" id="stat-pass">0</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 flex items-center justify-center">
                    <i class="fa-solid fa-check"></i>
                </div>
            </div>
             <!-- Warning (NEW) -->
             <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Warning</p>
                    <p class="text-3xl font-bold text-orange-500 dark:text-orange-400 mt-1" id="stat-warning">0</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-orange-50 dark:bg-orange-900/20 text-orange-500 dark:text-orange-400 flex items-center justify-center">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
            </div>
            <!-- Failed -->
            <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Failed</p>
                    <p class="text-3xl font-bold text-mitratel-red mt-1" id="stat-fail">0</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-red-50 dark:bg-red-900/20 text-mitratel-red flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </div>
            </div>
        </div>

        <!-- Area Drop Zone -->
        <div id="drop-area" class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl p-10 text-center hover:border-mitratel-red dark:hover:border-mitratel-red hover:bg-red-50 dark:hover:bg-red-900/10 transition-all cursor-pointer mb-8 group bg-gray-50 dark:bg-gray-800/50">
            <div class="space-y-4">
                <div class="w-16 h-16 bg-white dark:bg-gray-800 rounded-full shadow-sm flex items-center justify-center mx-auto group-hover:scale-110 transition-transform duration-300">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-300 group-hover:text-mitratel-red transition-colors"></i>
                </div>
                <div>
                    <p class="text-slate-600 dark:text-gray-300 font-medium text-lg">Drop your Excel files here</p>
                    <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Supports .xlsx, .xls (Mitratel Format)</p>
                </div>
            </div>
            <input type="file" id="fileElem" multiple accept=".xlsx, .xls, .csv" class="hidden">
        </div>

        <!-- Search & Filter Toolbar -->
        <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4 animate-fade-in">
            <div class="relative w-full md:w-96">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                </div>
                <input type="text" id="queueSearch" 
                    class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white text-sm rounded-xl focus:ring-mitratel-red focus:border-mitratel-red block w-full pl-10 p-2.5 shadow-sm transition-all" 
                    placeholder="Search Filename or PID..." onkeyup="filterQueueTable()">
            </div>
            
            <div class="flex items-center gap-2">
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-1 flex shadow-sm">
                    <button onclick="setQueueFilter('all')" id="filter-btn-all" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-slate-800 text-white shadow-md transform scale-105 transition-all">ALL</button>
                    <button onclick="setQueueFilter('PASS')" id="filter-btn-pass" class="px-3 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-green-600 hover:bg-green-50 dark:text-gray-400 dark:hover:bg-green-900/20 transition-all">PASS</button>
                    <!-- NEW WARNING FILTER -->
                    <button onclick="setQueueFilter('WARNING')" id="filter-btn-warning" class="px-3 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-orange-600 hover:bg-orange-50 dark:text-gray-400 dark:hover:bg-orange-900/20 transition-all">WARN</button>
                    <button onclick="setQueueFilter('FAIL')" id="filter-btn-fail" class="px-3 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-red-600 hover:bg-red-50 dark:text-gray-400 dark:hover:bg-red-900/20 transition-all">FAIL</button>
                </div>
            </div>
        </div>

        <!-- Tabel Hasil -->
        <div class="overflow-hidden rounded-xl border border-gray-200 dark:border-gray-700">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="py-4 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">No</th>
                        <th class="py-4 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Target PID / File</th>
                        <th class="py-4 px-6 text-center text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                        <th class="py-4 px-6 text-center text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Verified</th>
                        <th class="py-4 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Validation Log</th>
                        <th class="py-4 px-6 text-center text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="result-body" class="divide-y divide-gray-100 dark:divide-gray-800 bg-white dark:bg-gray-900">
                    <!-- Rows inserted via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- TAB: BATCHER (NEW FEATURE) -->
<div id="tab-batcher" class="hidden fade-in">
    <!-- ... (Tab Batcher Content Unchanged) ... -->
    <div class="max-w-7xl mx-auto">
        <div class="bg-white dark:bg-gray-900 w-full rounded-2xl shadow-xl shadow-gray-200/50 dark:shadow-none overflow-hidden border border-gray-100 dark:border-gray-800 p-8">
            <div class="border-b border-gray-100 dark:border-gray-800 pb-6 mb-8 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">Smart Batch Manager</h2>
                    <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Match Master List against a large folder and create validation batches.</p>
                </div>
                <div class="h-12 w-12 bg-blue-50 dark:bg-blue-900/20 rounded-xl flex items-center justify-center shadow-sm">
                    <i class="fa-solid fa-folder-tree text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Inputs -->
                <div class="space-y-6 lg:col-span-1">
                    <!-- Step 1: Master List -->
                    <div class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-xl border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold flex items-center justify-center">1</span>
                            <h3 class="font-bold text-slate-800 dark:text-white text-sm">Upload Master List</h3>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Upload Excel/CSV containing target PIDs/Filenames in the first column.</p>
                        <input type="file" id="batchMasterInput" accept=".xlsx, .xls, .csv" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-300 transition"/>
                        <div id="masterListStat" class="mt-2 text-xs font-mono text-emerald-600 dark:text-emerald-400 hidden">
                            <i class="fa-solid fa-check mr-1"></i> Loaded <span id="masterCount">0</span> targets
                        </div>
                    </div>

                    <!-- Step 2: Source Folder -->
                    <div class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-xl border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold flex items-center justify-center">2</span>
                            <h3 class="font-bold text-slate-800 dark:text-white text-sm">Select Source Folder</h3>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Select the folder containing all Excel files.</p>
                        <input type="file" id="batchFolderInput" webkitdirectory directory multiple class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-300 transition"/>
                        <div id="folderStat" class="mt-2 text-xs font-mono text-emerald-600 dark:text-emerald-400 hidden">
                            <i class="fa-solid fa-check mr-1"></i> Indexed <span id="folderCount">0</span> files
                        </div>
                    </div>

                    <!-- Step 3: Configure -->
                    <div class="bg-gray-50 dark:bg-gray-800/50 p-5 rounded-xl border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold flex items-center justify-center">3</span>
                            <h3 class="font-bold text-slate-800 dark:text-white text-sm">Batch Configuration</h3>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-400 mb-1">Batch Size</label>
                                <input type="number" id="batchSizeInput" value="50" min="1" class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:text-white">
                            </div>
                            <button onclick="runBatchMatching()" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 px-4 rounded-lg text-xs h-[38px] mt-auto transition shadow-lg transform active:scale-95">
                                Run Matcher
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Results -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Stats Card -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-blue-50 dark:bg-blue-900/10 p-4 rounded-xl border border-blue-100 dark:border-blue-900/30 text-center relative overflow-hidden group">
                             <div class="absolute -right-4 -top-4 text-blue-100 dark:text-blue-900/20 text-6xl group-hover:scale-110 transition-transform"><i class="fa-solid fa-check-double"></i></div>
                            <h4 class="text-xs font-bold text-blue-500 uppercase relative z-10">Matches Found</h4>
                            <p class="text-2xl font-bold text-blue-700 dark:text-blue-300 relative z-10" id="matchCount">0</p>
                        </div>
                        
                        <!-- MISSING FILES CARD (IMPROVED) -->
                        <div class="bg-orange-50 dark:bg-orange-900/10 p-4 rounded-xl border border-orange-100 dark:border-orange-900/30 text-center relative group">
                            <div class="absolute -right-4 -top-4 text-orange-100 dark:text-orange-900/20 text-6xl group-hover:scale-110 transition-transform"><i class="fa-solid fa-triangle-exclamation"></i></div>
                            <h4 class="text-xs font-bold text-orange-500 uppercase relative z-10">Missing Files</h4>
                            <p class="text-2xl font-bold text-orange-700 dark:text-orange-300 relative z-10" id="missingCount">0</p>
                            <!-- ACTION BUTTON FOR MISSING -->
                            <button id="btnViewMissing" onclick="viewMissingFiles()" class="hidden absolute bottom-2 right-2 left-2 mx-auto w-[90%] bg-orange-100 hover:bg-orange-200 dark:bg-orange-900/40 dark:hover:bg-orange-900/60 text-orange-700 dark:text-orange-300 text-[10px] font-bold py-1 rounded transition z-20">
                                View Details
                            </button>
                        </div>
                        
                        <div class="bg-purple-50 dark:bg-purple-900/10 p-4 rounded-xl border border-purple-100 dark:border-purple-900/30 text-center relative overflow-hidden group">
                            <div class="absolute -right-4 -top-4 text-purple-100 dark:text-purple-900/20 text-6xl group-hover:scale-110 transition-transform"><i class="fa-solid fa-layer-group"></i></div>
                            <h4 class="text-xs font-bold text-purple-500 uppercase relative z-10">Batches Created</h4>
                            <p class="text-2xl font-bold text-purple-700 dark:text-purple-300 relative z-10" id="batchCountDisplay">0</p>
                        </div>
                    </div>

                    <!-- Batches List -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col h-[400px]">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800">
                            <div class="flex items-center gap-2">
                                <h3 class="font-bold text-sm text-slate-700 dark:text-gray-200">Generated Batches</h3>
                                <!-- DOWNLOAD MANIFEST BTN -->
                                <button onclick="downloadBatchManifest()" id="btnDownloadManifest" class="hidden text-[10px] bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 px-2 py-1 rounded border border-gray-200 dark:border-gray-600 transition" title="Download Excel Report of Batches & Missing Files">
                                    <i class="fa-solid fa-file-excel mr-1 text-green-600"></i> Report
                                </button>
                            </div>
                            <button onclick="sendBatchToValidator('all')" id="btnSendAllBatch" class="hidden bg-mitratel-red hover:bg-red-700 text-white text-xs font-bold px-3 py-1.5 rounded transition shadow-sm">
                                <i class="fa-solid fa-paper-plane mr-1"></i> Send ALL to Validator
                            </button>
                        </div>
                        <div id="batchListContainer" class="flex-1 overflow-y-auto p-4 space-y-3">
                            <div class="text-center text-gray-400 py-10 italic">
                                Run matching to generate batches...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TAB: CONVERTER (Content Unchanged) -->
<div id="tab-converter" class="hidden fade-in">
   <!-- ... (Converter Content) ... -->
    <div class="max-w-4xl mx-auto">
        <div class="bg-white dark:bg-gray-900 w-full rounded-2xl shadow-xl shadow-gray-200/50 dark:shadow-none overflow-hidden border border-gray-100 dark:border-gray-800">
            <!-- Header -->
            <div class="bg-gray-50 dark:bg-gray-800/50 p-8 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">Universal Converter</h2>
                    <p class="text-slate-500 dark:text-gray-400 text-sm mt-1">Merge or Convert Excel &amp; Text files efficiently.</p>
                </div>
                <div class="h-12 w-12 bg-white dark:bg-gray-700 rounded-xl flex items-center justify-center shadow-sm">
                    <i class="fa-solid fa-shuffle text-mitratel-red text-xl"></i>
                </div>
            </div>
            
            <div class="p-8 space-y-8">
                <!-- 1. Source Format -->
                <div>
                    <h3 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-4">1. Select Source Format</h3>
                    <div class="flex gap-3">
                        <button id="modeExcel" class="flex-1 py-3 px-4 rounded-xl border-2 border-mitratel-red bg-red-50 dark:bg-red-900/10 text-mitratel-red font-semibold transition-all flex items-center justify-center gap-2">
                            <i class="fa-regular fa-file-excel"></i> Excel (.xlsx)
                        </button>
                        <button id="modeText" class="flex-1 py-3 px-4 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 hover:border-gray-300 dark:hover:border-gray-600 transition-all flex items-center justify-center gap-2">
                            <i class="fa-regular fa-file-lines"></i> Text (.txt)
                        </button>
                    </div>
                </div>

                <!-- 2. Drop Zone -->
                <div class="drop-zone w-full h-48 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors relative group" id="dropZone">
                    <input accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" id="fileInput" multiple="" type="file"/>
                    <div class="text-center pointer-events-none transition-transform group-hover:scale-105 duration-300">
                        <i class="fa-solid fa-folder-open text-4xl text-gray-300 dark:text-gray-600 mb-3 group-hover:text-mitratel-red transition-colors" id="dropIcon"></i>
                        <p class="text-slate-600 dark:text-gray-300 font-medium">Click or Drag files here</p>
                        <p class="text-slate-400 dark:text-gray-500 text-xs mt-1" id="acceptText">Accepts multiple .xlsx files</p>
                    </div>
                </div>

                <!-- File List -->
                <div class="hidden" id="fileListContainer">
                    <div class="flex justify-between items-end mb-3">
                        <h3 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Queue (<span id="fileCount">0</span>)</h3>
                        <button class="text-xs text-red-500 hover:text-red-700 font-bold uppercase" id="clearBtn">Clear All</button>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 max-h-48 overflow-y-auto file-list-container p-3 space-y-2" id="fileList">
                        <!-- Files will be injected here -->
                    </div>
                </div>

                <!-- 3. Output Options -->
                <div>
                    <h3 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-4">2. Output Configuration</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                                <input checked="" class="w-5 h-5 text-mitratel-red focus:ring-mitratel-red border-gray-300" name="outputMode" type="radio" value="merge"/>
                                <span class="text-sm font-medium text-slate-700 dark:text-gray-300">Merge into single file</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                                <input class="w-5 h-5 text-mitratel-red focus:ring-mitratel-red border-gray-300" name="outputMode" type="radio" value="separate"/>
                                <span class="text-sm font-medium text-slate-700 dark:text-gray-300">Keep separate files</span>
                            </label>
                        </div>
                        
                        <!-- Custom Filename Input -->
                        <div class="transition-all duration-300" id="filenameContainer">
                            <label class="block text-xs font-bold uppercase tracking-wider text-gray-400 mb-2" for="customFilename">
                                Filename (Merge Only)
                            </label>
                            <div class="flex items-center">
                                <input class="w-full text-sm p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-l-xl focus:ring-2 focus:ring-mitratel-red focus:border-mitratel-red outline-none transition" id="customFilename" placeholder="Project_Merged" type="text"/>
                                <div class="bg-gray-100 dark:bg-gray-700 border border-l-0 border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-300 px-4 py-3 text-sm rounded-r-xl font-mono">.txt</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Button -->
                <button class="w-full bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold py-4 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed hover:bg-mitratel-red dark:hover:bg-gray-200 transition-all shadow-lg transform active:scale-[0.99] flex items-center justify-center gap-3" disabled="" id="convertBtn">
                    <span>Run Conversion</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                
                <!-- Status Log -->
                <div class="hidden text-xs font-mono bg-gray-50 dark:bg-gray-950 dark:text-gray-400 p-4 rounded-xl border border-gray-200 dark:border-gray-800 max-h-32 overflow-y-auto" id="statusLog"></div>
            </div>
        </div>
    </div>
</div>

<!-- ... (Modals remain unchanged) ... -->
<!-- MODALS -->
<!-- 1. Guide Modal -->
<div id="guideModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 transition-opacity">
    <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl max-w-2xl w-full p-8 relative border border-gray-100 dark:border-gray-800">
        <button onclick="toggleGuide()" class="absolute top-6 right-6 text-gray-400 hover:text-slate-900 dark:hover:text-white transition">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">User Guide <span class="text-mitratel-red">v4.31</span></h2>
        <div class="space-y-4 text-sm text-slate-600 dark:text-gray-300 overflow-y-auto max-h-[60vh] pr-2">
             <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                <h3 class="font-bold text-slate-900 dark:text-white mb-2"><i class="fa-solid fa-keyboard text-mitratel-red mr-2"></i>New: Keyboard Shortcuts</h3>
                <ul class="list-disc pl-5 mt-2 space-y-1 text-xs">
                    <li><span class="bg-gray-200 dark:bg-gray-700 px-1 rounded font-mono">← / →</span> : Navigate between files in visualizer.</li>
                    <li><span class="bg-gray-200 dark:bg-gray-700 px-1 rounded font-mono">1-4</span> : Switch Tabs (Viz, Display, Data, Log).</li>
                    <li><span class="bg-gray-200 dark:bg-gray-700 px-1 rounded font-mono">W/A/S/D</span> : Pan Topology View.</li>
                    <li><span class="bg-gray-200 dark:bg-gray-700 px-1 rounded font-mono">+ / -</span> : Zoom In/Out.</li>
                    <li><span class="bg-gray-200 dark:bg-gray-700 px-1 rounded font-mono">F</span> : Force Status Toggle (Fail <-> Pass).</li>
                    <li><span class="bg-gray-200 dark:bg-gray-700 px-1 rounded font-mono">V</span> : Verify Structure.</li>
                    <li><span class="bg-gray-200 dark:bg-gray-700 px-1 rounded font-mono">Esc</span> : Close visualizer.</li>
                </ul>
            </div>
             <!-- New Rules Explanation -->
             <div class="p-4 bg-orange-50 dark:bg-orange-900/10 rounded-xl mt-4 border border-orange-100 dark:border-orange-800">
                <h3 class="font-bold text-slate-900 dark:text-white mb-2"><i class="fa-solid fa-star text-orange-500 mr-2"></i>New Rules (v4.31)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                    <div>
                        <strong class="text-red-600 dark:text-red-400">R16: Anti-Split (FAIL)</strong>
                        <p class="mt-1">Project ID dalam satu segmen tidak boleh terputus. Harus berurutan.</p>
                    </div>
                    <div>
                        <strong class="text-red-600 dark:text-red-400">R17: Sequential (FAIL)</strong>
                        <p class="mt-1">Urutan aset anak (JC01, KU01) harus mulai dari 01 dan tidak boleh ada gap.</p>
                    </div>
                    <div>
                        <strong class="text-orange-600 dark:text-orange-400">R18: High Occupancy (WARN)</strong>
                        <p class="mt-1">Peringatan jika satu PID menggunakan lebih dari 4 core dalam satu segmen.</p>
                    </div>
                     <div>
                        <strong class="text-red-600 dark:text-red-400">R19: Connectivity (FAIL)</strong>
                        <p class="mt-1">Check konektivitas pada Segmen (STRNO 21). Memastikan rantai OTB-ODC, ODC-ODC, ODC-CLOSURE terhubung. <b>Pengecualian:</b> CLOSURE-CLOSURE ke ODC/OTB dianggap Valid. Dan jika baris mengandung ODC/OTB dianggap titik sambung Valid.</p>
                    </div>
                    <!-- NEW R20 EXPLANATION -->
                     <div>
                        <strong class="text-orange-600 dark:text-orange-400">R20: Display Ring Chain (WARN)</strong>
                        <p class="mt-1">Check konektivitas pada sheet display_ring. Baris ke-2 (Input) harus sama persis dengan Baris ke-1 (Output) sebelumnya. (Peringatan saja, judgement user).</p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl mt-4">
                <h3 class="font-bold text-slate-900 dark:text-white mb-2"><i class="fa-solid fa-anchor text-mitratel-red mr-2"></i>Rule 13, 14 & 15 (Anchor PID)</h3>
                <p class="mt-2 text-xs"><strong>R13:</strong> Anchor PID (dari nama file) harus muncul setidaknya sekali di file.</p>
                <p class="mt-1 text-xs"><strong>R14:</strong> Anchor PID harus ditemukan di <strong>Segmen Pertama</strong> (Rentetan core paling awal dalam file).</p>
                <p class="mt-1 text-xs"><strong>R15:</strong> Anchor PID harus ditemukan di <strong>SEMUA Segmen</strong> yang ada dalam file (Universal Segment Presence). Tidak boleh ada segmen kabel yang "bolong" tanpa PID project.</p>
            </div>
        </div>
    </div>
</div>
<!-- Viz Modal & Missing Files Modal omitted for brevity but assumed present unchanged -->
<!-- 2. Viz Modal (Full Screen) -->
<div id="vizModal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm hidden z-50 flex flex-col transition-opacity duration-300">
    <!-- Content same as before, simplified for brevity in this view but fully preserved in output -->
    <div class="m-auto bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-[98%] h-[95vh] flex flex-col overflow-hidden border border-gray-200 dark:border-gray-800">
        <!-- Header -->
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900">
            <div class="flex items-center gap-4">
                <div>
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-3">
                        <i class="fa-solid fa-eye text-mitratel-red"></i>
                        Detail View
                        <span id="targetPidDisplay" class="font-mono text-xs bg-slate-100 dark:bg-gray-800 text-slate-600 dark:text-gray-300 px-2 py-1 rounded border border-gray-200 dark:border-gray-700"></span>
                        <span id="vizStatusBadge" class="font-bold text-xs px-2 py-1 rounded uppercase"></span>
                    </h3>
                    <p class="text-xs text-gray-400 mt-1" id="modalFileName">Filename.xlsx</p>
                </div>
                <!-- Manual Verify Button (New Feature) -->
                <button id="btnVerifyStructure" onclick="toggleVerification()" class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide border transition-all">
                    <!-- Text and icon set by JS -->
                </button>
                 <!-- NEW: Force Toggle Button in Viz -->
                 <button id="btnForceToggleViz" onclick="toggleForceStatusFromViz()" class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide border transition-all bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 dark:text-gray-300">
                    <i class="fa-solid fa-gavel"></i> Override Status
                </button>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                    <button id="btnModalPrev" onclick="navigateFile(-1)" class="w-10 h-8 rounded-md flex items-center justify-center hover:bg-white dark:hover:bg-gray-700 shadow-sm disabled:opacity-30 disabled:shadow-none transition" title="Previous (Left Arrow)">
                        <i class="fa-solid fa-chevron-left text-xs"></i>
                    </button>
                    <div class="w-px bg-gray-300 dark:bg-gray-600 mx-1 h-4 self-center"></div>
                    <button id="btnModalNext" onclick="navigateFile(1)" class="w-10 h-8 rounded-md flex items-center justify-center hover:bg-white dark:hover:bg-gray-700 shadow-sm disabled:opacity-30 disabled:shadow-none transition" title="Next (Right Arrow)">
                        <i class="fa-solid fa-chevron-right text-xs"></i>
                    </button>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-500 transition flex items-center justify-center">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Tab Nav -->
        <div class="flex px-6 border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 space-x-6 overflow-x-auto">
            <button onclick="switchTab('viz')" id="tab-viz" class="nav-btn py-4 text-sm font-semibold text-mitratel-red active whitespace-nowrap">
                Visual Topology
            </button>
            <button onclick="switchTab('display')" id="tab-display" class="nav-btn py-4 text-sm font-medium text-gray-500 hover:text-slate-800 dark:text-gray-400 dark:hover:text-white whitespace-nowrap">
                Display Data
            </button>
            <button onclick="switchTab('data')" id="tab-data" class="nav-btn py-4 text-sm font-medium text-gray-500 hover:text-slate-800 dark:text-gray-400 dark:hover:text-white whitespace-nowrap">
                Tenant Data
            </button>
            <!-- New Error Tab -->
            <button onclick="switchTab('errors')" id="tab-errors" class="nav-btn py-4 text-sm font-medium text-gray-500 hover:text-slate-800 dark:text-gray-400 dark:hover:text-white whitespace-nowrap">
                Validation Log <span id="error-badge" class="ml-1 bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded-full hidden">0</span>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-hidden relative bg-gray-100 dark:bg-gray-950">
            <!-- Viz -->
            <div id="content-viz" class="absolute inset-0">
                <div id="viz-scroll-container">
                    <div id="viz-scale-container" class="origin-top-left p-12 min-w-max min-h-max transition-transform duration-200">
                         <div class="flex flex-col items-center justify-center h-full text-gray-300 dark:text-gray-600 mt-20 gap-4">
                             <i class="fa-solid fa-circle-notch fa-spin text-4xl"></i>
                             <p class="font-medium">Rendering Topology...</p>
                         </div>
                    </div>
                </div>
                <!-- Controls -->
                <div class="absolute bottom-8 right-8 flex flex-col gap-2">
                    <button onclick="changeZoom(0.1)" class="w-10 h-10 bg-white dark:bg-gray-800 rounded-full shadow-lg text-slate-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center transition border border-gray-100 dark:border-gray-700">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button onclick="resetZoom()" class="w-10 h-10 bg-white dark:bg-gray-800 rounded-full shadow-lg text-slate-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center transition border border-gray-100 dark:border-gray-700">
                        <i class="fa-solid fa-compress"></i>
                    </button>
                    <button onclick="changeZoom(-0.1)" class="w-10 h-10 bg-white dark:bg-gray-800 rounded-full shadow-lg text-slate-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center transition border border-gray-100 dark:border-gray-700">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
            </div>

            <!-- Display Table -->
            <div id="content-display" class="absolute inset-0 p-8 hidden flex flex-col bg-white dark:bg-gray-900">
                 <div class="flex justify-between items-center mb-6">
                    <h4 class="font-bold text-slate-800 dark:text-white">Sheet: display_ring</h4>
                    <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">Filtered View</span>
                </div>
                <div class="flex-1 overflow-auto rounded-xl border border-gray-200 dark:border-gray-800">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-800 text-xs">
                        <thead class="bg-gray-50 dark:bg-gray-800" id="display-ring-head"></thead>
                        <tbody id="display-ring-body" class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-800"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tenant Data -->
            <div id="content-data" class="absolute inset-0 p-8 hidden flex flex-col bg-white dark:bg-gray-900">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="relative w-full md:w-80">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="tableSearch" placeholder="Search STRNO, PID..." class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-800 border-none rounded-lg text-sm focus:ring-2 focus:ring-mitratel-red focus:outline-none dark:text-white" onkeyup="filterTable()">
                    </div>
                    
                    <!-- New Filter Buttons -->
                    <div class="flex items-center gap-2 overflow-x-auto w-full md:w-auto pb-1 md:pb-0">
                         <button onclick="setLenFilter('all')" id="len-btn-all" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-mitratel-red text-white transition shadow-sm whitespace-nowrap">ALL</button>
                         <button onclick="setLenFilter('17')" id="len-btn-17" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 transition whitespace-nowrap">SPAN (17)</button>
                         <button onclick="setLenFilter('21')" id="len-btn-21" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 transition whitespace-nowrap">SEG (21)</button>
                         <button onclick="setLenFilter('26')" id="len-btn-26" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 transition whitespace-nowrap">ELM (26)</button>
                         <button onclick="setLenFilter('30')" id="len-btn-30" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 transition whitespace-nowrap">CORE (30)</button>
                    </div>

                    <div class="text-xs font-mono text-gray-500 whitespace-nowrap">
                        <span id="showStart">0</span>-<span id="showEnd">0</span> of <span id="totalRows">0</span>
                    </div>
                </div>
                <div class="flex-1 overflow-auto rounded-xl border border-gray-200 dark:border-gray-800">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-800">
                        <thead class="bg-gray-50 dark:bg-gray-800 sticky-header">
                            <tr>
                                <th class="py-3 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">STRNO</th>
                                <th class="py-3 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">ABCKZ</th>
                                <th class="py-3 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">PLTXT</th>
                                <th class="py-3 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">STORT</th>
                                <th class="py-3 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">ARBPL</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="bg-white dark:bg-gray-900 divide-y divide-gray-100 dark:divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button onclick="changePage(-1)" id="btnPrev" class="px-4 py-2 border border-gray-200 dark:border-gray-700 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-800 dark:text-white">Previous</button>
                    <span id="pageIndicator" class="px-4 py-2 text-sm font-medium dark:text-white flex items-center">Page 1</span>
                    <button onclick="changePage(1)" id="btnNext" class="px-4 py-2 border border-gray-200 dark:border-gray-700 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-800 dark:text-white">Next</button>
                </div>
            </div>

            <!-- Error Log Tab -->
            <div id="content-errors" class="absolute inset-0 p-8 hidden flex flex-col bg-white dark:bg-gray-900">
                <div class="flex justify-between items-center mb-6">
                    <h4 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <i class="fa-solid fa-triangle-exclamation text-red-500"></i>
                        Validation Errors
                    </h4>
                    <span class="text-xs bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-300 px-3 py-1 rounded-full font-medium" id="error-count-display">0 Issues Found</span>
                </div>
                <div class="flex-1 overflow-auto rounded-xl border border-gray-200 dark:border-gray-800">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-800">
                        <thead class="bg-gray-50 dark:bg-gray-800 sticky-header">
                            <tr>
                                <th class="py-3 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase w-24">Row</th>
                                <th class="py-3 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase w-40">Rule</th>
                                <th class="py-3 px-6 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Message</th>
                            </tr>
                        </thead>
                        <tbody id="error-table-body" class="bg-white dark:bg-gray-900 divide-y divide-gray-100 dark:divide-gray-800">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3. Missing Files Modal (NEW) -->
<div id="missingFilesModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4 transition-opacity">
    <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full p-6 relative border border-gray-100 dark:border-gray-800">
        <button onclick="closeMissingFiles()" class="absolute top-4 right-4 text-gray-400 hover:text-slate-900 dark:hover:text-white transition">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h2 class="text-lg font-bold text-slate-900 dark:text-white">Missing Files Report</h2>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">The following PIDs/Files from your Master List were NOT found in the source folder:</p>
        
        <div class="bg-gray-50 dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-lg p-3 max-h-[300px] overflow-y-auto mb-4">
            <ul id="missingFilesList" class="space-y-1 text-xs font-mono text-slate-700 dark:text-gray-300">
                <!-- List items via JS -->
            </ul>
        </div>
        
        <div class="flex justify-end gap-2">
            <button onclick="downloadBatchManifest()" class="bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold px-4 py-2 rounded-lg transition">
                <i class="fa-solid fa-download mr-2"></i>Download Full Report
            </button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
        // ... (Dark Mode Logic and Global State - Unchanged) ...
        // --- DARK MODE LOGIC ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
                icon.className = 'fa-regular fa-moon';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
                icon.className = 'fa-regular fa-sun';
            }
        }

        // Init Dark Mode
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('themeIcon').className = 'fa-regular fa-sun';
        } else {
            document.documentElement.classList.remove('dark');
        }

        // --- MASTER DATA WORK CENTER (Unchanged) ---
        const MASTER_WC_CSV = `STORT,ARBPL
AMB0,D12
BAU0,D11
BDG0,D05
BDL0,D03
BGL0,D03
BGR0,D04
BIM0,D08
BIT0,D11
BJB0,D09
BJM0,D09
BJR0,D05
BKS0,D04
BKT0,D02
BLT0,D07
BNA0,D01
BNJ0,D01
BON0,D09
BPP0,D09
BTM0,D02
BTU0,D07
CBN0,D05
CKG0,D04
CLG0,D04
CMH0,D05
CPT0,D04
DPK0,D04
DPR0,D08
DUM0,D02
GGP0,D04
GST0,D01
GTO0,D11
JAP0,D12
JMB0,D03
KDI0,D11
KDR0,D07
KPG0,D08
KTG0,D11
KYB0,D04
LGS0,D01
LLG0,D03
LSM0,D01
MAD0,D07
MDN0,D01
MET0,D03
MGG0,D06
MJK0,D07
MKS0,D11
MLG0,D07
MND0,D11
MTR0,D08
PAD0,D02
PAL0,D11
PBL0,D07
PBM0,D03
PBR0,D02
PDP0,D02
PGA0,D03
PGP0,D03
PKL0,D06
PLG0,D03
PLK0,D09
PLP0,D11
PMN0,D02
PMS0,D01
PRE0,D11
PSN0,D07
PSP0,D01
PTK0,D09
PYH0,D02
SAB0,D01
SBG0,D01
SBY0,D07
SKB0,D04
SKT0,D06
SKW0,D09
SLK0,D02
SLT0,D06
SMG0,D06
SMR0,D09
SON0,D12
SPN0,D03
SRG0,D04
SUS0,D01
SWL0,D02
TAR0,D09
TBT0,D01
TDR0,D11
TGL0,D06
TJB0,D01
TJP0,D04
TMH0,D11
TNA0,D04
TNG0,D04
TPG0,D02
TSM0,D05
TTE0,D11
TUL0,D12
YYK0,D06
ADL1,D11
AFT1,D12
AGM1,D03
AGT1,D12
AKK1,D01
AMR1,D11
AMS1,D12
AMT1,D09
ANG1,D12
APN1,D11
ARM1,D11
ARS1,D02
ATB1,D08
BAA1,D08
BAG1,D11
BAN1,D11
BAR1,D11
BBS1,D06
BBU1,D03
BDW1,D07
BEK1,D09
BEN1,D11
BGI1,D11
BGK1,D11
BHN1,D03
BIK1,D12
BIR1,D01
BJN1,D07
BJW1,D08
BKJ1,D01
BKL1,D07
BKN1,D02
BKO1,D03
BLA1,D06
BLG1,D01
BLI1,D08
BLK1,D11
BLN1,D09
BLS1,D02
BLU1,D11
BNG1,D11
BNR1,D06
BNT1,D09
BOB1,D11
BPD1,D01
BRB1,D09
BRG1,D08
BRK1,D11
BRM1,D12
BSB1,D02
BSK1,D02
BTA1,D03
BTG1,D06
BTI1,D12
BTL1,D06
BTN1,D08
BTW1,D12
BUL1,D11
BYL1,D06
BYW1,D07
CAG1,D01
CBI1,D04
CJR1,D05
CKR1,D04
CLP1,D06
CMS1,D05
CRP1,D03
DGL1,D11
DKL1,D02
DLS1,D01
DMK1,D06
DOB1,D12
DPU1,D08
DRB1,D11
DRH1,D12
DTH1,D12
ELL1,D12
END1,D08
ENR1,D11
ERT1,D12
FEF1,D12
FFK1,D12
GDT1,D03
GIN1,D08
GNS1,D03
GNT1,D01
GRG1,D08
GRT1,D05
GSK1,D07
GST1,D01
IDL1,D03
IDM1,D05
ILG1,D12
JAP1,D12
JBG1,D07
JLL1,D11
JMR1,D07
JNP1,D11
JPA1,D06
JTH1,D01
KAG1,D03
KBA1,D03
KBG1,D12
KBJ1,D01
KBK1,D12
KBM1,D06
KBR1,D09
KDL1,D06
KDR1,D07
KDS1,D06
KEP1,D12
KFM1,D08
KGM1,D12
KGN1,D09
KIS1,D01
KJN1,D06
KKA1,D11
KKN1,D09
KLA1,D03
KLB1,D08
KLK1,D09
KLN1,D06
KLP1,D09
KLT1,D03
KMN1,D12
KND1,D11
KNG1,D05
KNR1,D07
KOT1,D03
KPG1,D08
KPH1,D03
KPI1,D01
KPN1,D07
KRA1,D08
KRB1,D01
KRG1,D06
KRS1,D07
KRT1,D03
KRU1,D03
KSN1,D09
KSU1,D04
KTB1,D03
KTN1,D01
KTP1,D09
KWD1,D11
KWG1,D04
KYM1,D12
LBA1,D11
LBB1,D02
LBJ1,D08
LBK1,D11
LBP1,D01
LBS1,D02
LBT1,D11
LGR1,D11
LGS1,D01
LHM1,D01
LHT1,D03
LIW1,D03
LLK1,D11
LMG1,D07
LMJ1,D07
LMP1,D01
LRT1,D08
LSK1,D01
LSS1,D11
LTU1,D01
LWB1,D08
LWK1,D11
MAB1,D11
MAK1,D11
MAM1,D11
MAR1,D11
MBL1,D03
MBN1,D03
MBO1,D01
MBY1,D08
MGL1,D03
MGN1,D11
MGR1,D03
MGT1,D07
MGW1,D08
MJK1,D07
MJL1,D05
MJN1,D11
MJY1,D07
MKD1,D06
MKM1,D03
MLL1,D11
MLN1,D09
MME1,D08
MMS1,D11
MNA1,D03
MNK1,D12
MPR1,D03
MPW1,D09
MRB1,D03
MRD1,D03
MRE1,D03
MRH1,D09
MRJ1,D02
MRK1,D12
MRN1,D01
MRS1,D11
MRT1,D03
MSB1,D11
MSH1,D12
MSJ1,D03
MSK1,D03
MTK1,D03
MTP1,D09
MTW1,D09
MUL1,D12
NAB1,D12
NBA1,D09
NGA1,D08
NGB1,D09
NGP1,D09
NGW1,D07
NJK1,D07
NLA1,D12
NMR1,D12
NNK1,D09
NPH1,D05
NPM1,D02
ODS1,D11
OSB1,D12
PAG1,D05
PBG1,D06
PBU1,D09
PCT1,D07
PDA1,D02
PDG1,D04
PIN1,D11
PKB1,D03
PKJ1,D11
PKK1,D02
PKY1,D11
PLI1,D09
PLJ1,D02
PLP1,D11
PLW1,D11
PMK1,D07
PML1,D06
PMS1,D01
PNG1,D07
PNJ1,D09
PNN1,D02
PPS1,D09
PRC1,D09
PRG1,D11
PRN1,D09
PRP1,D02
PRR1,D01
PRW1,D03
PSO1,D11
PSP1,D01
PSR1,D07
PSW1,D11
PTI1,D06
PTS1,D09
PWD1,D06
PWK1,D04
PWR1,D06
PWT1,D06
PYA1,D08
PYB1,D01
RAH1,D11
RAN1,D02
RAP1,D01
RAS1,D12
RBG1,D06
RGT1,D02
RKB1,D04
RMB1,D11
RNK1,D12
RPT1,D03
RTA1,D09
RTG1,D08
RTN1,D11
RTP1,D11
SAG1,D09
SAK1,D02
SAL1,D01
SBB1,D08
SBG1,D01
SBH1,D01
SBM1,D04
SBR1,D05
SBS1,D09
SBW1,D08
SDA1,D07
SDK1,D01
SDN1,D03
SDR1,D11
SDW1,D09
SED1,D09
SEL1,D08
SGB1,D11
SGI1,D01
SGL1,D03
SGM1,D11
SGN1,D06
SGP1,D12
SGR1,D08
SGT1,D09
SIT1,D07
SKD1,D09
SKG1,D11
SKH1,D06
SKL1,D01
SKM1,D01
SKN1,D11
SKR1,D09
SKY1,D03
SLW1,D06
SMD1,D05
SMH1,D12
SMI1,D12
SML1,D12
SMN1,D06
SMP1,D07
SNB1,D01
SNG1,D05
SNJ1,D11
SNN1,D11
SNT1,D03
SOE1,D08
SOR1,D05
SPA1,D05
SPE1,D02
SPG1,D07
SPN1,D03
SPT1,D09
SRG1,D04
SRH1,D01
SRK1,D02
SRL1,D03
SRP1,D08
SRU1,D12
SRW1,D12
SRY1,D09
STB1,D01
STG1,D09
STR1,D01
SWG1,D11
SWW1,D11
TAB1,D08
TAM1,D08
TAS1,D03
TBD1,D11
TBG1,D03
TBH1,D02
TBK1,D02
TBL1,D03
TBN1,D07
TDN1,D03
TDP1,D09
TGR1,D04
TGT1,D09
THN1,D11
TIG1,D12
TIM1,D12
TJG1,D09
TJN1,D08
TJS1,D09
TKA1,D11
TKN1,D01
TKR1,D12
TLB1,D03
TLD1,D01
TLG1,D07
TLI1,D11
TLK1,D02
TLW1,D08
TMB1,D12
TMG1,D06
TML1,D09
TMR1,D12
TMT1,D11
TNN1,D11
TNR1,D09
TOB1,D11
TOM1,D12
TPT1,D02
TRG1,D09
TRK1,D07
TRP1,D02
TRT1,D01
TRW1,D11
TTG1,D02
TTN1,D01
TTY1,D11
TUB1,D03
TUL1,D12
TWG1,D03
UJB1,D09
UJT1,D02
UNH1,D11
UNR1,D06
WAM1,D12
WAS1,D12
WAT1,D06
WBL1,D08
WED1,D11
WGD1,D11
WGP1,D08
WGW1,D11
WHO1,D08
WKB1,D08
WNG1,D06
WNO1,D06
WNS1,D11
WRS1,D12
WSB1,D06
WTP1,D11`;

        // --- GLOBAL STATE ---
        const appState = {
            queue: [],
            processed: {}, 
            processedKeys: [], 
            currentData: [],
            filteredData: [],
            currentPage: 1,
            rowsPerPage: 100,
            targetPID: "",
            currentFileIndex: -1, 
            stats: { total: 0, pass: 0, fail: 0, warning: 0 }, // Added warning to stats
            workCenterData: new Map(),
            currentLenFilter: 'all' // New State for Length Filter
        };

        const batcherState = {
            targetFiles: new Set(),
            folderMap: new Map(),
            batches: [],
            matchCount: 0,
            missingCount: 0,
            missingFiles: [] 
        };


        // --- GAMIFICATION SYSTEM ---
        const GameSystem = {
            stats: { xp: 0, level: 1, verifiedCount: 0 },
            verifiedPids: [], // Stores list of manually verified PIDs

            init: function() {
                const storedStats = localStorage.getItem('mitratel_user_stats');
                const storedPids = localStorage.getItem('mitratel_verified_pids');
                if(storedStats) this.stats = JSON.parse(storedStats);
                if(storedPids) this.verifiedPids = JSON.parse(storedPids);
                this.updateUI();
            },

            addXP: function(amount, reason) {
                this.stats.xp += amount;
                this.checkLevelUp();
                this.save();
                this.updateUI();
                showToast(`+${amount} XP: ${reason}`, 'success');
            },

            checkLevelUp: function() {
                // Simple level logic: Level = 1 + floor(XP / 500)
                const newLevel = 1 + Math.floor(this.stats.xp / 500);
                if (newLevel > this.stats.level) {
                    this.stats.level = newLevel;
                    showToast(`Level Up! You are now level ${newLevel}`, 'info');
                }
            },

            markVerified: function(pid) {
                if(!this.verifiedPids.includes(pid)) {
                    this.verifiedPids.push(pid);
                    this.stats.verifiedCount++;
                    this.addXP(50, "Manual Verification"); // Bonus XP for manual check
                    this.save();
                    return true;
                }
                return false;
            },

            unmarkVerified: function(pid) {
                const idx = this.verifiedPids.indexOf(pid);
                if(idx > -1) {
                    this.verifiedPids.splice(idx, 1);
                    this.stats.verifiedCount = Math.max(0, this.stats.verifiedCount - 1);
                    // Penalize XP slightly? Maybe not, just don't refund.
                    this.save();
                    this.updateUI();
                    return true;
                }
                return false;
            },

            isVerified: function(pid) {
                return this.verifiedPids.includes(pid);
            },

            getRankName: function() {
                const lvl = this.stats.level;
                if(lvl < 2) return "Intern Validator";
                if(lvl < 5) return "Junior Officer";
                if(lvl < 10) return "Senior Asset Mgr";
                if(lvl < 20) return "VP of Towers";
                return "Master Validator";
            },

            save: function() {
                localStorage.setItem('mitratel_user_stats', JSON.stringify(this.stats));
                localStorage.setItem('mitratel_verified_pids', JSON.stringify(this.verifiedPids));
            },

            updateUI: function() {
                document.getElementById('userLevel').innerText = `Lvl ${this.stats.level}`;
                document.getElementById('userXp').innerText = this.stats.xp;
                document.getElementById('userRank').innerText = this.getRankName();
                
                // XP Bar calculation (0-500 based for simple levels)
                const currentLevelXp = this.stats.xp % 500;
                const percentage = (currentLevelXp / 500) * 100;
                document.getElementById('xpBar').style.width = `${percentage}%`;
            }
        };

        // --- VISUALIZATION STATE ---
        let vizScale = 1.0;

        // --- INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", () => {
            GameSystem.init();
            setupKeyboardShortcuts();
            
            // --- Parse Master Data ---
            const lines = MASTER_WC_CSV.split('\n');
            let loadedCount = 0;
            lines.forEach((line, index) => {
                if(index === 0) return; // Skip header
                const [stort, arbpl] = line.split(',').map(s => s.trim());
                if(stort && arbpl) {
                    appState.workCenterData.set(stort, arbpl);
                    loadedCount++;
                }
            });
            console.log(`Loaded ${loadedCount} Work Center rules.`);

            // Drag Scroll Logic
            const scrollContainer = document.getElementById('viz-scroll-container');
            let isDown = false;
            let startX, startY, scrollLeft, scrollTop;

            scrollContainer.addEventListener('mousedown', (e) => {
                isDown = true;
                scrollContainer.classList.add('active');
                startX = e.pageX - scrollContainer.offsetLeft;
                startY = e.pageY - scrollContainer.offsetTop;
                scrollLeft = scrollContainer.scrollLeft;
                scrollTop = scrollContainer.scrollTop;
            });
            
            scrollContainer.addEventListener('mouseleave', () => { isDown = false; });
            scrollContainer.addEventListener('mouseup', () => { isDown = false; });
            
            scrollContainer.addEventListener('mousemove', (e) => {
                if(!isDown) return;
                e.preventDefault();
                const x = e.pageX - scrollContainer.offsetLeft;
                const y = e.pageY - scrollContainer.offsetTop;
                const walkX = (x - startX) * 1.5; 
                const walkY = (y - startY) * 1.5;
                scrollContainer.scrollLeft = scrollLeft - walkX;
                scrollContainer.scrollTop = scrollTop - walkY;
            });
            
            // Mouse Wheel Zoom
            scrollContainer.addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    e.preventDefault();
                    if (e.deltaY < 0) changeZoom(0.1);
                    else changeZoom(-0.1);
                }
            });
        });

        // --- KEYBOARD SHORTCUTS ---
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Only allow shortcuts if modal is open
                const modal = document.getElementById('vizModal');
                if (modal.classList.contains('hidden')) return;

                // Ignore if user is typing in a search input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                // Tab Switching (1-4)
                if(['1','2','3','4'].includes(e.key)) {
                    if(e.key === '1') switchTab('viz');
                    if(e.key === '2') switchTab('display');
                    if(e.key === '3') switchTab('data');
                    if(e.key === '4') switchTab('errors');
                    return;
                }

                // Check if Visual Topology Tab is Active
                const isVizActive = !document.getElementById('content-viz').classList.contains('hidden');
                
                // Visualizer specific controls (Zoom & Pan)
                if (isVizActive) {
                    const step = 50;
                    switch(e.key.toLowerCase()) {
                        // Panning (WASD)
                        case "w": panViz(0, -step); break;
                        case "a": panViz(-step, 0); break;
                        case "s": panViz(0, step); break;
                        case "d": panViz(step, 0); break;
                        
                        // Zooming (+ / -)
                        case "c": // + key usually requires shift, but = is the unshifted key on standard keyboards
                        case "C": changeZoom(0.1); break;
                        case "x": 
                        case "X": changeZoom(-0.1); break;
                        case "z":
                        case "Z": resetZoom(); break;
                    }
                }

                switch(e.key) {
                    case "q":
		    case "Q":
                        navigateFile(-1);
                        break;
                    case "e":
                    case "E":
                        navigateFile(1);
                        break;
                    case "Escape":
                        closeModal();
                        break;
                    case "v":
                    case "V":
                        toggleVerification();
                        break;
                    case "f":
                    case "F":
                        toggleForceStatusFromViz();
                        break;
                }
            });
        }

        // --- PANNING HELPER ---
        function panViz(dx, dy) {
            const container = document.getElementById('viz-scroll-container');
            if(container) {
                // Direct assignment is smoother for repetitive key press than scrollBy behavior
                container.scrollLeft += dx;
                container.scrollTop += dy;
            }
        }

        // --- ZOOM LOGIC ---
        function changeZoom(delta) {
            vizScale += delta;
            if (vizScale < 0.2) vizScale = 0.2;
            if (vizScale > 3.0) vizScale = 3.0;
            applyZoom();
        }

        function resetZoom() {
            vizScale = 1.0;
            applyZoom();
        }

        function applyZoom() {
            const container = document.getElementById('viz-scale-container');
            container.style.transform = `scale(${vizScale})`;
        }

        // --- UI HANDLERS ---
        function toggleGuide() { document.getElementById('guideModal').classList.toggle('hidden'); }
        function closeModal() { document.getElementById('vizModal').classList.add('hidden'); }
        function closeMissingFiles() { document.getElementById('missingFilesModal').classList.add('hidden'); }
        
        function toggleBatchMenu(e) {
            e.stopPropagation();
            document.getElementById('batchMenu').classList.toggle('hidden');
        }

        function toggleSapMenu(e) {
            e.stopPropagation();
            document.getElementById('sapMenu').classList.toggle('hidden');
        }

        function closeDropdowns(e) {
            // Close Batch menu
            if (!e.target.closest('#batchMenu') && !e.target.closest('button[onclick="toggleBatchMenu(event)"]')) {
                document.getElementById('batchMenu').classList.add('hidden');
            }
            // Close SAP menu
            if (!e.target.closest('#sapMenu') && !e.target.closest('button[onclick="toggleSapMenu(event)"]')) {
                document.getElementById('sapMenu').classList.add('hidden');
            }
        }

        // --- QUEUE SEARCH & FILTER LOGIC ---
        let currentQueueFilter = 'all';

        function setQueueFilter(status) {
            currentQueueFilter = status;
            
            // Update Buttons
            ['all', 'pass', 'fail', 'warning'].forEach(s => {
                const btn = document.getElementById(`filter-btn-${s.toLowerCase()}`);
                if(!btn) return;

                if (s.toUpperCase() === status.toUpperCase() || (s === 'all' && status === 'all')) {
                    if(s === 'all') btn.className = "px-3 py-1.5 text-xs font-bold rounded-lg bg-slate-800 text-white shadow-md transform scale-105 transition-all";
                    if(s === 'pass') btn.className = "px-3 py-1.5 text-xs font-bold rounded-lg bg-green-500 text-white shadow-md transform scale-105 transition-all";
                    if(s === 'fail') btn.className = "px-3 py-1.5 text-xs font-bold rounded-lg bg-mitratel-red text-white shadow-md transform scale-105 transition-all";
                    if(s === 'warning') btn.className = "px-3 py-1.5 text-xs font-bold rounded-lg bg-orange-500 text-white shadow-md transform scale-105 transition-all";
                } else {
                    btn.className = "px-3 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition-all";
                }
            });

            filterQueueTable();
        }

        function filterQueueTable() {
            const input = document.getElementById('queueSearch');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('result-body');
            const tr = table.getElementsByTagName('tr');

            for (let i = 0; i < tr.length; i++) {
                // Column 1 is Filename/PID, Column 2 is Status
                const tdName = tr[i].getElementsByTagName("td")[1]; 
                const tdStatus = tr[i].getElementsByTagName("td")[2]; 
                
                if (tdName && tdStatus) {
                    const txtValue = tdName.textContent || tdName.innerText;
                    const statusText = tdStatus.textContent || tdStatus.innerText;
                    
                    const matchesSearch = txtValue.toUpperCase().indexOf(filter) > -1;
                    let matchesFilter = true;

                    if (currentQueueFilter !== 'all') {
                        // Strict check to differentiate FAIL vs WARNING
                        // Status text might contain extra chars, so simple .includes is usually fine
                        // But if filter is FAIL, we want to match FAIL, not WARNING.
                        if (!statusText.toUpperCase().includes(currentQueueFilter.toUpperCase())) {
                            matchesFilter = false;
                        }
                    }

                    if (matchesSearch && matchesFilter) {
                        tr[i].style.display = "";
                        tr[i].classList.add("animate-fade-in");
                    } else {
                        tr[i].style.display = "none";
                        tr[i].classList.remove("animate-fade-in");
                    }
                }       
            }
        }

        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgClass = type === 'success' ? 'bg-emerald-500' : 'bg-blue-500';
            if (type === 'error') bgClass = 'bg-red-500';

            toast.className = `toast ${bgClass} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2`;
            toast.innerHTML = `<i class="fa-solid fa-bell"></i> <span>${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        // --- VERIFICATION LOGIC ---
        function toggleVerification() {
            const pid = appState.targetPID;
            if(!pid) return;

            if (GameSystem.isVerified(pid)) {
                // Unmark
                GameSystem.unmarkVerified(pid);
                updateVerifyButton(false);
            } else {
                // Mark
                GameSystem.markVerified(pid);
                updateVerifyButton(true);
            }
            
            // Refresh table row indicator if visible
            const processedItem = Object.values(appState.processed).find(p => p.pid === pid);
            if(processedItem && processedItem.rowId) {
                updateTableRowVerifiedStatus(processedItem.rowId, pid);
            }
        }

        function updateVerifyButton(isVerified) {
            const btn = document.getElementById('btnVerifyStructure');
            if (isVerified) {
                btn.className = "hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide border transition-all bg-green-100 text-green-700 border-green-200 hover:bg-green-200";
                btn.innerHTML = `<i class="fa-solid fa-circle-check"></i> Structure Verified`;
            } else {
                btn.className = "hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide border transition-all bg-white dark:bg-gray-800 text-gray-500 border-gray-300 dark:border-gray-600 hover:border-mitratel-red hover:text-mitratel-red";
                btn.innerHTML = `<i class="fa-regular fa-square"></i> Mark Verified`;
            }
        }

        function updateTableRowVerifiedStatus(rowId, pid) {
            const row = document.getElementById(rowId);
            if(!row) return;
            // Column 4 is "Verified"
            const cell = row.cells[3]; 
            if(GameSystem.isVerified(pid)) {
                cell.innerHTML = `<span class="text-emerald-500 text-lg" title="Manually Verified"><i class="fa-solid fa-circle-check"></i></span>`;
            } else {
                cell.innerHTML = `<span class="text-gray-300 text-lg"><i class="fa-regular fa-circle"></i></span>`;
            }
        }

        // --- FORCE STATUS TOGGLE LOGIC (NEW) ---
        function toggleForceStatus(fileName) {
            const item = appState.processed[fileName];
            if(!item) return;

            // Toggle logic
            if (item.status === 'PASS' || item.status === 'WARNING') {
                item.status = 'FAIL';
                item.isManuallyOverridden = true;
                item.originalStatus = item.originalStatus || 'PASS';
            } else {
                item.status = 'PASS';
                item.isManuallyOverridden = true;
                item.originalStatus = item.originalStatus || 'FAIL';
            }

            // Restore if back to original (optional, but let's keep it overridden to allow "Force" concept)
            // If we want to strictly toggle, we just swap PASS/FAIL.

            // Update UI components
            recalculateStats();
            updateRowStatusUI(item.rowId, item);
            
            // If open in visualizer, update that too
            if (appState.targetPID === item.pid && !document.getElementById('vizModal').classList.contains('hidden')) {
                updateVizStatusHeader(item);
                updateForceToggleButton(item);
            }

            showToast(`Status updated to ${item.status}`, item.status === 'PASS' ? 'success' : 'error');
        }

        function toggleForceStatusFromViz() {
            // Find filename from pid
            const pid = appState.targetPID;
            const item = Object.values(appState.processed).find(p => p.pid === pid);
            if (item) {
                toggleForceStatus(item.fileName);
            }
        }

        function updateVizStatusHeader(item) {
            const badge = document.getElementById('vizStatusBadge');
            badge.innerText = item.status;
            if (item.status === 'PASS') {
                badge.className = "font-bold text-xs px-2 py-1 rounded uppercase bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300";
            } else if (item.status === 'WARNING') {
                badge.className = "font-bold text-xs px-2 py-1 rounded uppercase bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300";
            } else {
                badge.className = "font-bold text-xs px-2 py-1 rounded uppercase bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300";
            }
            if (item.isManuallyOverridden) {
                badge.classList.add('status-badge-manual');
                badge.innerHTML += ` <i class="fa-solid fa-gavel ml-1" title="Manually Overridden"></i>`;
            }
        }
        
        function updateForceToggleButton(item) {
             const btn = document.getElementById('btnForceToggleViz');
             btn.classList.remove('hidden'); // Ensure visible
             if (item.status === 'PASS') {
                 // Option to Force Fail
                 btn.innerHTML = `<i class="fa-solid fa-thumbs-down text-red-500"></i> Force Fail`;
                 btn.className = "hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide border transition-all bg-white hover:bg-red-50 border-red-200 text-red-600 dark:bg-gray-800 dark:border-gray-700 dark:text-red-400";
             } else {
                 // Option to Force Pass
                 btn.innerHTML = `<i class="fa-solid fa-thumbs-up text-green-500"></i> Force Pass`;
                 btn.className = "hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide border transition-all bg-white hover:bg-green-50 border-green-200 text-green-600 dark:bg-gray-800 dark:border-gray-700 dark:text-green-400";
             }
        }

        function updateRowStatusUI(rowId, item) {
            const row = document.getElementById(rowId);
            if (!row) return;

            const statusCell = row.cells[2];
            const actionCell = row.cells[5];

            let statusClass = "";
            if (item.status === 'PASS') {
                statusClass = "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300";
            } else if (item.status === 'WARNING') {
                statusClass = "bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300";
            } else {
                statusClass = "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300";
            }
            
            let statusHtml = `<span class="${statusClass} py-1 px-3 rounded-md text-xs font-bold uppercase tracking-wider">${item.status}</span>`;
            if (item.isManuallyOverridden) {
                statusHtml += `<div class="text-[9px] text-gray-500 mt-1"><i class="fa-solid fa-gavel"></i> Manual</div>`;
            }
            statusCell.innerHTML = statusHtml;

            // Regenerate Action Buttons
            const toggleIcon = item.status === 'PASS' ? 'fa-thumbs-down' : 'fa-thumbs-up';
            const toggleTitle = item.status === 'PASS' ? 'Force Fail' : 'Force Pass';
            const toggleColor = item.status === 'PASS' ? 'text-red-500 hover:bg-red-50' : 'text-green-500 hover:bg-green-50';

            const wbOut = XLSX.write(item.wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbOut], { type: "application/octet-stream" });
            const url = URL.createObjectURL(blob);

            actionCell.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                    <button onclick="openVisualizer('${item.fileName}')" class="bg-slate-100 hover:bg-slate-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-slate-700 dark:text-white p-2 rounded-lg transition" title="Visualize">
                       <i class="fa-solid fa-eye"></i>
                    </button>
                    <button onclick="toggleForceStatus('${item.fileName}')" class="bg-white border border-gray-200 dark:bg-gray-800 dark:border-gray-600 ${toggleColor} p-2 rounded-lg transition" title="${toggleTitle}">
                       <i class="fa-solid ${toggleIcon}"></i>
                    </button>
                    <a href="${url}" download="VALIDATED_v4_${item.fileName}" class="bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-300 p-2 rounded-lg transition" title="Download XLSX">
                       <i class="fa-solid fa-file-excel"></i>
                    </a>
                    <button onclick="downloadSapTxt('${item.fileName}')" class="bg-emerald-50 hover:bg-emerald-100 dark:bg-emerald-900/20 dark:hover:bg-emerald-900/40 text-emerald-600 dark:text-emerald-300 p-2 rounded-lg transition" title="Download SAP TXT">
                       <i class="fa-solid fa-file-code"></i>
                    </button>
                </div>
            `;
        }

        // --- CLEAR QUEUE FUNCTION ---
        function clearValidatorQueue() {
            if(!confirm("Are you sure you want to clear all files from the queue?")) return;

            appState.queue = [];
            appState.processed = {};
            appState.processedKeys = [];
            appState.stats = { total: 0, pass: 0, fail: 0, warning: 0 };
            
            // Clear UI
            document.getElementById('result-body').innerHTML = '';
            document.getElementById('btnStartValidation').classList.add('hidden');
            document.getElementById('summary-dashboard').classList.add('hidden');
            document.getElementById('groupActions').classList.add('hidden');
            document.getElementById('btnClearFiles').classList.add('hidden');
            
            // Reset File Input
            document.getElementById('fileElem').value = '';
        }

        // --- HELPER FUNCTION: EXTRACT ANCHOR PID ---
        // Consistent PID extraction logic for both display and validation (Rule 13)
        function extractAnchorPid(filename) {
            const nameBase = filename.replace(/\.[^/.]+$/, ""); // Remove extension
            // Try standard pattern
            const pidMatch = nameBase.match(/\b\d{2}[A-Z]{2}\d{2}[A-Z]\d{4}\b/i);
            
            if (pidMatch) {
                return pidMatch[0].toUpperCase();
            }
            
            // If no regex match, fallback to cleaning common prefixes/suffixes manually
            let clean = nameBase.toUpperCase();
            
            // Handle prefixes
            clean = clean.replace(/^VALIDATED_/, '');
            clean = clean.replace(/^REVISI_/, '');
            
            // Handle suffixes
            clean = clean.replace(/_VALIDATED$/, '');
            clean = clean.replace(/_REVISI$/, '');
            clean = clean.replace(/_FINAL$/, '');

            return clean;
        }

        // --- SAP TXT helpers --- (Unchanged)
        function sanitizeForTsvCell(val) {
            if (val === null || val === undefined) return '';
            return String(val)
                .replace(/\t/g, ' ')
                .replace(/\r?\n/g, ' ')
                .trim();
        }

        function buildSapTxtFromRows(rows, headerOrder) {
            if (!rows || rows.length === 0) return '';
            const cols = headerOrder && headerOrder.length ? headerOrder : Object.keys(rows[0]);
            const headerLine = cols.join('\t');
            const bodyLines = rows.map(r => cols.map(c => sanitizeForTsvCell(r[c])).join('\t'));
            return [headerLine, ...bodyLines].join('\r\n');
        }

        function triggerTextDownload(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadSapTxt(fileName) {
            const item = appState.processed[fileName];
            if (!item || !item.sapTxt) {
                alert("SAP TXT belum tersedia untuk file ini.");
                return;
            }
            const base = item.pid || fileName.replace(/\.[^/.]+$/, "");
            triggerTextDownload(item.sapTxt, base + ".txt");
        }

        async function downloadSapBatch(type, mode) {
            if (Object.keys(appState.processed).length === 0) {
                alert("Belum ada file yang diproses.");
                return;
            }

            const eligible = Object.values(appState.processed).filter(item => {
                if (type === 'all') return true;
                if (type === 'pass') return item.status === 'PASS';
                if (type === 'fail') return item.status === 'FAIL';
                return false;
            });

            if (eligible.length === 0) {
                alert("Tidak ada file yang sesuai kriteria.");
                return;
            }

            if (mode === 'merge') {
                const mergedNameInput = document.getElementById('sapMergedFilename')?.value?.trim();
                const firstBase = eligible[0].pid || eligible[0].fileName.replace(/\.[^/.]+$/, "");
                let outName = mergedNameInput || (firstBase + "_SAP_MERGED_PASS.txt");
                if (!outName.toLowerCase().endsWith('.txt')) outName += '.txt';

                const mergedLines = [];
                for (let i = 0; i < eligible.length; i++) {
                    const item = eligible[i];
                    if (!item.sapTxt) continue;
                    const lines = item.sapTxt.split(/\r?\n/);
                    if (lines.length === 0) continue;
                    if (mergedLines.length === 0) mergedLines.push(...lines);
                    else mergedLines.push(...lines.slice(1)); // skip header
                }

                if (mergedLines.length === 0) {
                    alert("Tidak ada konten SAP TXT yang bisa digabung.");
                    return;
                }
                triggerTextDownload(mergedLines.join('\r\n'), outName);
                return;
            }

            // Separate downloads
            if (!confirm(`Akan mengunduh ${eligible.length} file TXT. Pastikan Anda mengizinkan 'Automatic Downloads' di browser Anda.

Lanjutkan?`)) {
                return;
            }

            for (let i = 0; i < eligible.length; i++) {
                const item = eligible[i];
                if (!item.sapTxt) continue;
                const base = item.pid || item.fileName.replace(/\.[^/.]+$/, "");
                triggerTextDownload(item.sapTxt, base + ".txt");
                await new Promise(resolve => setTimeout(resolve, 250));
            }
        }

        const dropArea = document.getElementById('drop-area');
        const fileElem = document.getElementById('fileElem');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            dropArea.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileElem.click());
        fileElem.addEventListener('change', (e) => handleFiles(e.target.files), false);

        function handleDrop(e) { handleFiles(e.dataTransfer.files); }

        async function handleFiles(files) {
            const tbody = document.getElementById('result-body');
            let added = false;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                const fileId = `file-${Date.now()}-${i}`;
                appState.queue.push({ file, id: fileId });
                added = true;

                // --- REVISI: Menggunakan Helper extractAnchorPid agar konsisten dengan Rule 13 ---
                const targetPid = extractAnchorPid(file.name);

                const tr = document.createElement('tr');
                tr.id = fileId;
                tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition border-b border-gray-50 dark:border-gray-800";
                
                // Added Verified Column in HTML
                tr.innerHTML = `
                    <td class="py-4 px-6 text-sm text-gray-400 font-mono">${tbody.children.length + 1}</td>
                    <td class="py-4 px-6 text-sm font-semibold text-slate-700 dark:text-gray-200">
                        ${file.name}
                        <br><span class="text-[10px] uppercase font-bold text-gray-500 bg-gray-100 dark:bg-gray-700 dark:text-gray-400 px-1.5 py-0.5 rounded tracking-wide mt-1 inline-block">ID: ${targetPid}</span>
                    </td>
                    <td class="py-4 px-6 text-center text-xs font-bold text-gray-400 bg-gray-50 dark:bg-gray-800 rounded-lg">Pending</td>
                    <td class="py-4 px-6 text-center text-gray-300">-</td>
                    <td class="py-4 px-6 text-sm text-gray-400 italic">Ready to process...</td>
                    <td class="py-4 px-6 text-center text-gray-300">-</td>
                `;
                tbody.appendChild(tr);
            }

            if (added) {
                document.getElementById('btnStartValidation').classList.remove('hidden');
                document.getElementById('btnClearFiles').classList.remove('hidden');
                document.getElementById('summary-dashboard').classList.remove('hidden');
                
                // Re-apply filter if active (to hide/show this new row)
                if(window.currentQueueFilter && window.currentQueueFilter !== 'all') {
                    filterQueueTable();
                } else if(document.getElementById('queueSearch').value.trim() !== "") {
                    filterQueueTable();
                }
            }
        }

        async function startBatchValidation() {
            const btn = document.getElementById('btnStartValidation');
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = `<span class="loader border-t-white mr-2" style="width:16px;height:16px;border-width:2px;"></span> Processing...`;

            // Reset stats - but wait, appState.stats tracks processed files.
            // If we are appending to queue, maybe we shouldn't reset to 0 unless we cleared queue?
            // Existing logic resets.
            appState.stats.total = 0;
            appState.stats.pass = 0;
            appState.stats.fail = 0;
            appState.stats.warning = 0; // Reset warning
            updateDashboardUI();

            for (const item of appState.queue) {
                await processFile(item.file, item.id);
            }
            
            appState.queue = []; 
            btn.innerHTML = "<i class='fa-solid fa-check mr-2'></i> Done";
            document.getElementById('groupActions').classList.remove('hidden');

            setTimeout(() => { 
                btn.classList.add('hidden'); 
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = `<i class='fa-solid fa-play mr-2 text-xs'></i> Start Validation`;
            }, 2000);
        }

        // NEW: Recalculate stats helper to handle toggles
        function recalculateStats() {
            let total = 0, pass = 0, fail = 0, warning = 0;
            Object.values(appState.processed).forEach(item => {
                total++;
                if (item.status === 'PASS') pass++;
                else if (item.status === 'WARNING') warning++;
                else fail++;
            });
            appState.stats = { total, pass, fail, warning };
            updateDashboardUI();
        }

        function updateDashboardUI() {
            document.getElementById('stat-total').innerText = appState.stats.total;
            document.getElementById('stat-pass').innerText = appState.stats.pass;
            document.getElementById('stat-fail').innerText = appState.stats.fail;
            document.getElementById('stat-warning').innerText = appState.stats.warning; // UI Warning
            
            document.getElementById('badge-all').innerText = appState.stats.total;
            document.getElementById('badge-pass').innerText = appState.stats.pass;
            document.getElementById('badge-fail').innerText = appState.stats.fail;

            // SAP badge mirrors
            const sapAll = document.getElementById('badge-sap-all');
            const sapPass = document.getElementById('badge-sap-pass');
            if (sapAll) sapAll.innerText = appState.stats.total;
            if (sapPass) sapPass.innerText = appState.stats.pass;
        }

        function downloadSummaryReport() {
            if (Object.keys(appState.processed).length === 0) {
                alert("Tidak ada data validasi untuk diunduh.");
                return;
            }

            // --- REVISI FORMAT SUMMARY REPORT SESUAI REQUEST ---
            const summaryData = Object.values(appState.processed).map((item) => {
                // 1. Kolom PID
                const pid = item.pid || item.fileName.replace(/\.[^/.]+$/, "");

                // 2. Kolom Cek Asset (Status Custom)
                // Bila Pass -> "Done Upload SAP (Cek)", Bila Fail -> "NY OK"
                let cekAsset = "NY OK";
                if(item.status === "PASS") cekAsset = "Done Upload SAP (Cek)";
                else if(item.status === "WARNING") cekAsset = "Done (WARNING)";

                // 3. Kolom Remarks (Message Error)
                let remarks = "";
                
                // Combine Errors and Warnings
                const allIssues = [...item.errors, ...(item.warnings || [])];

                if (allIssues.length > 0) {
                    // Ambil semua pesan error
                    const messages = allIssues.map(e => e.Message);
                    
                    // Deduplikasi: "bila error validation ada 1 lebih tapi sama maka samain aja"
                    const uniqueMessages = [...new Set(messages)];
                    
                    // Append: "kalau beda maka append"
                    remarks = uniqueMessages.join("; ");
                } else if (item.status === "PASS") {
                    remarks = "No Issues Found";
                }

                return {
                    PID: pid,
                    "Cek Asset": cekAsset,
                    Remarks: remarks
                };
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(summaryData);
            
            // Adjust column widths (PID: 25, Status: 25, Remarks: 100/Wide)
            ws['!cols'] = [{wch: 25}, {wch: 25}, {wch: 100}];

            XLSX.utils.book_append_sheet(wb, ws, "SUMMARY");
            XLSX.writeFile(wb, "SUMMARY_REPORT.xlsx");
        }

        async function downloadBatch(type) {
            const filesToDownload = [];
            if (Object.keys(appState.processed).length === 0) {
                alert("Belum ada file yang diproses.");
                return;
            }

            for (const key in appState.processed) {
                const item = appState.processed[key];
                let shouldAdd = false;

                if (type === 'all') shouldAdd = true;
                else if (type === 'pass' && item.status === 'PASS') shouldAdd = true;
                else if (type === 'fail' && item.status === 'FAIL') shouldAdd = true;

                if (shouldAdd) {
                    filesToDownload.push({
                        fileName: "VALIDATED_" + item.fileName,
                        wb: item.wb
                    });
                }
            }

            if (filesToDownload.length === 0) {
                alert("Tidak ada file yang sesuai kriteria.");
                return;
            }

            if (!confirm(`Akan mengunduh ${filesToDownload.length} file. Pastikan Anda mengizinkan 'Automatic Downloads' di browser Anda.\n\nLanjutkan?`)) {
                return;
            }

            for (let i = 0; i < filesToDownload.length; i++) {
                const file = filesToDownload[i];
                downloadSingleExcel(file.wb, file.fileName);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        function downloadSingleExcel(wb, fileName) {
            const excelData = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([excelData], { type: "application/octet-stream" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        const isEmpty = (x) => (x === null || x === undefined || String(x).trim() === "");
        const excelRow = (i) => i + 2;

        async function processFile(file, rowId) {
            const row = document.getElementById(rowId);
            const statusCell = row.cells[2];
            const verifiedCell = row.cells[3]; // New column index
            const msgCell = row.cells[4];
            const actionCell = row.cells[5];

            statusCell.innerHTML = `<span class="loader"></span>`;
            msgCell.innerText = "Running checks...";

            try {
                // ... (Excel Processing Logic - Unchanged) ...
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                if (!workbook.SheetNames.includes('below_ring')) throw new Error("Sheet 'below_ring' tidak ditemukan.");
                
                let rawBelow = XLSX.utils.sheet_to_json(workbook.Sheets['below_ring'], { defval: "" });
                
                // --- MODIFIED MAPPING TO INCLUDE EXCEL ROW INDEX ---
                let belowData = rawBelow.map((r, idx) => {
                    const newRow = {};
                    Object.keys(r).forEach(k => {
                        const upperK = k.toUpperCase().trim();
                        if (['PID', 'RING_ID'].includes(upperK)) return; 
                        newRow[upperK] = r[k];
                    });
                    newRow._rowIndex = idx + 2; // Store Excel Row Index (1-based + header)
                    return newRow;
                });

                const required = ['STRNO', 'PLTXT', 'ABCKZ'];
                const missing = required.filter(c => !Object.keys(belowData[0] || {}).includes(c));
                if (missing.length) throw new Error(`Kolom hilang di below_ring: ${missing.join(', ')}`);

                belowData.sort((a, b) => {
                    const sa = String(a.STRNO || "");
                    const sb = String(b.STRNO || "");
                    return sa.localeCompare(sb);
                });

                // --- MODIFIED: Added Logic to Rewrite PLTXT if STRNO len is 17 ---
                belowData.forEach(r => {
                    const s = String(r.STRNO || "");
                    const len = (s.toLowerCase() === "<na>" || s === "") ? 0 : s.length;
                    r.STRNO_LENGTH = len;

                    // --- NEW RULE: Auto-Rewrite PLTXT for SPAN (Len 17) ---
                    if (len === 17) {
                        r.PLTXT = s; // Copy STRNO to PLTXT
                    }
                });

                const errors = [];
                const warnings = []; // NEW: Array for Warnings (R18)
                const rule5_Allowed = [17, 21, 26, 30];
                const seenStrno = new Set();
                const duplicates = new Set();

                // --- EXTRACT ANCHOR PID USING HELPER ---
                const anchorPid = extractAnchorPid(file.name);

                // --- PRE-PROCESS: GROUP BY SEGMENT FOR RULE 14 & 15 ---
                // Helper to track which segments contain the Anchor PID
                const segmentMap = {}; // { "SEGMENT_ID": boolean (hasAnchor?) }
                let segmentOrder = []; // To keep track of order (for finding first segment)

                // =======================================================
                // R16 (Anti-Split), R17 (Sequential), R18 (Occupancy) Helpers
                // =======================================================
                const r16Segments = {}; // { segId: { currentPid: null, seenPids: Set() } }
                const r17MaterialGroups = {}; // { groupKey: [numbers] }
                const r18Occupancy = {}; // { segId: { pid: count } }

                belowData.forEach((r, i) => {
                    const strno = String(r.STRNO || "").trim();
                    const pltxt = String(r.PLTXT || "").trim();
                    
                    // -- R13/R14/R15 Logic (Existing) --
                    if (r.STRNO_LENGTH === 30) {
                         const segId = strno.substring(0, 26);
                         
                         // Init segment if new
                         if (!segmentMap.hasOwnProperty(segId)) {
                             segmentMap[segId] = false;
                             segmentOrder.push(segId);
                         }

                         const p = pltxt.toUpperCase();
                         if (p.includes(anchorPid)) {
                             segmentMap[segId] = true;
                         }

                         // -- R16 Logic: Anti-Split per Segment --
                         if (!r16Segments[segId]) r16Segments[segId] = { currentPid: null, seenPids: new Set() };
                         const segState = r16Segments[segId];

                         // Normalize PID for continuity check (treat Empty as a distinct 'GAP' state or just null)
                         const normPid = pltxt ? pltxt : "EMPTY_CORE"; 
                         
                         if (normPid !== segState.currentPid) {
                             // Change Detected
                             if (segState.seenPids.has(normPid) && normPid !== "EMPTY_CORE") {
                                 // FAIL: PID muncul kembali setelah terputus
                                 errors.push({
                                     Rule: "R16_ANTI_SPLIT",
                                     Row: r._rowIndex,
                                     Message: `PID '${pltxt}' terputus (Anti-Split). PID ini muncul kembali di segmen ${segId} setelah diselingi PID lain/Core Kosong.`
                                 });
                             }
                             // Record old PID as seen
                             if (segState.currentPid && segState.currentPid !== "EMPTY_CORE") {
                                 segState.seenPids.add(segState.currentPid);
                             }
                             // Update current
                             segState.currentPid = normPid;
                         }

                         // -- R18 Logic: High Occupancy (Warning) --
                         if (pltxt && !pltxt.toUpperCase().includes("KABEL")) {
                             const basePid = pltxt.replace(/\[R\]|\(R\)/gi, '').trim().toUpperCase();
                             if (!r18Occupancy[segId]) r18Occupancy[segId] = {};
                             r18Occupancy[segId][basePid] = (r18Occupancy[segId][basePid] || 0) + 1;
                         }
                    }

                    // -- R17 Logic: Sequential Check (Assets) --
                    // Valid for LEN 26 (Assets like JC, KU, ODP) or derived logic
                    if (r.STRNO_LENGTH === 26) {
                        // Regex to capture trailing number: e.g. ...-JC01 -> Group: ...-JC, Num: 01
                        // Adjust regex based on expected format. Usually Last 2 chars are digits.
                        const match = strno.match(/^(.+?)([A-Z]+)(\d+)$/); 
                        // Example: S06-020-JC01 -> Group 1: S06-020-, Group 2: JC, Group 3: 01
                        if (match) {
                            const groupKey = match[1] + match[2]; // Parent+Type
                            const numVal = parseInt(match[3], 10);
                            
                            if (!r17MaterialGroups[groupKey]) r17MaterialGroups[groupKey] = [];
                            r17MaterialGroups[groupKey].push({ num: numVal, row: r._rowIndex, strno: strno });
                        }
                    }
                });

                // -- Post-Process R17 (Sequential) --
                Object.keys(r17MaterialGroups).forEach(key => {
                    const items = r17MaterialGroups[key].sort((a,b) => a.num - b.num);
                    if (items.length > 0) {
                        // Check 1: Start from 1
                        if (items[0].num !== 1) {
                            errors.push({
                                Rule: "R17_SEQUENTIAL_START",
                                Row: items[0].row,
                                Message: `Urutan aset '${key}' dimulai dari nomor ${items[0].num}, seharusnya 01.`
                            });
                        }
                        // Check 2: Gaps
                        for (let k = 1; k < items.length; k++) {
                            const diff = items[k].num - items[k-1].num;
                            if (diff > 1) {
                                errors.push({
                                    Rule: "R17_SEQUENTIAL_GAP",
                                    Row: items[k].row,
                                    Message: `Lompatan urutan aset '${key}'. Dari ${items[k-1].strno} langsung ke ${items[k].strno} (Gap detected).`
                                });
                            }
                        }
                    }
                });

                // -- Post-Process R18 (Occupancy Warning) --
                Object.keys(r18Occupancy).forEach(segId => {
                    const pidCounts = r18Occupancy[segId];
                    Object.keys(pidCounts).forEach(pid => {
                        if (pidCounts[pid] > 4) {
                            warnings.push({
                                Rule: "R18_HIGH_OCCUPANCY",
                                Row: `SEGMENT ${segId}`,
                                Message: `PID '${pid}' menggunakan ${pidCounts[pid]} core dalam satu segmen. (Threshold > 4). Mohon cek manual.`
                            });
                        }
                    });
                });

                // --- NEW RULE 19: CONNECTIVITY CHECK (UPDATED WITH SPECIAL LOGIC) ---
                // Filter Segmen (Len 21)
                const segments = belowData.filter(r => r.STRNO_LENGTH === 21);
                // Sort by STRNO secara fisik untuk memastikan urutan segmen
                segments.sort((a,b) => String(a.STRNO||"").localeCompare(String(b.STRNO||"")));

                for(let k=0; k < segments.length - 1; k++) {
                    const curr = segments[k];
                    const next = segments[k+1];

                    const currTxt = String(curr.PLTXT || "").toUpperCase().trim();
                    const nextTxt = String(next.PLTXT || "").toUpperCase().trim();
                    const currStrno = String(curr.STRNO || "").toUpperCase().trim();
                    const nextStrno = String(next.STRNO || "").toUpperCase().trim();

                    // --- CASE C: Span/Ring Break Check ---
                    // Helper to extract Span ID (everything before the last segment number)
                    // Example: R10-WTP1-R003-S01-030 -> Span: R10-WTP1-R003-S01
                    const extractSpan = (str) => {
                         const parts = str.split('-');
                         if (parts.length > 1) {
                             return parts.slice(0, -1).join('-'); 
                         }
                         return str;
                    };

                    const currSpan = extractSpan(currStrno);
                    const nextSpan = extractSpan(nextStrno);

                    if (currSpan !== nextSpan) {
                        continue; // Case C: Span changed, valid break.
                    }

                    // --- CASE A & B: Special Infra Logic ---
                    const isCurrClosure = currTxt.includes("CLOSURE-CLOSURE");
                    const hasInfraCurr = currTxt.includes("ODC") || currTxt.includes("OTB");
                    const hasInfraNext = nextTxt.includes("ODC") || nextTxt.includes("OTB");

                    // Case A: CLOSURE-CLOSURE followed by Infra
                    if (isCurrClosure && hasInfraNext) {
                        continue; // Valid Override
                    }

                    // Case B: Current is Infra (ODC/OTB) -> Connects to anything (valid bridge)
                    if (hasInfraCurr) {
                        continue; // Valid Override
                    }

                    // --- STANDARD CHECK (Token Intersection) ---
                    const splitRegex = /[\-\/\s]+/; 
                    const currTokens = currTxt.split(splitRegex).filter(t => t.length > 1);
                    const nextTokens = nextTxt.split(splitRegex).filter(t => t.length > 1);
                    
                    const hasCommon = currTokens.some(token => nextTokens.includes(token));

                    if (!hasCommon) {
                        errors.push({
                            Rule: "R19_CONNECTIVITY",
                            Row: curr._rowIndex, 
                            Message: `Putus Konektivitas Segmen: '${curr.PLTXT}' tidak menyambung ke '${next.PLTXT}' (dalam Span yang sama: ${currSpan}).`
                        });
                    }
                }

                // --- RULE 14: ANCHOR PID IN FIRST SEGMENT ---
                if (segmentOrder.length > 0) {
                    const firstSegId = segmentOrder[0];
                    if (segmentMap[firstSegId] === false) {
                        errors.push({
                            Rule: "R14_ANCHOR_START",
                            Row: "FIRST_SEGMENT",
                            Message: `Anchor PID '${anchorPid}' wajib ada di Segmen Pertama (${firstSegId}). File ini dimulai dengan project lain/kosong.`
                        });
                    }
                }

                // --- NEW RULE 15: ANCHOR PID IN ALL SEGMENTS ---
                segmentOrder.forEach(segId => {
                    if (segmentMap[segId] === false) {
                        errors.push({
                            Rule: "R15_ANCHOR_SEGMENT_MISSING",
                            Row: "SEGMENT_CHECK",
                            Message: `Segmen ${segId} tidak memuat Anchor PID '${anchorPid}' sama sekali. Anchor PID wajib ada di setiap segmen.`
                        });
                    }
                });

                belowData.forEach((r, i) => {
                    const len = r.STRNO_LENGTH;
                    const strno = String(r.STRNO || "").trim();
                    const abckz = String(r.ABCKZ || "").trim().toUpperCase();

                    if (!rule5_Allowed.includes(len)) {
                        errors.push({ Rule: "R5_LENGTH", Row: r._rowIndex, Message: `Panjang ${len} tidak valid. STRNO: ${strno}` });
                    }
                    if (seenStrno.has(strno)) {
                        duplicates.add(strno);
                        errors.push({ Rule: "R9_DUPLICATE", Row: r._rowIndex, Message: `Duplikat STRNO: ${strno}` });
                    } else {
                        seenStrno.add(strno);
                    }
                    const baseMap = { 17: "P", 21: "S", 30: "O" };
                    if (baseMap[len]) {
                        if (abckz !== baseMap[len]) {
                            errors.push({ Rule: "R7_ABCKZ", Row: r._rowIndex, Message: `Len ${len} harus ABCKZ='${baseMap[len]}', tapi tertulis '${abckz}'` });
                        }
                    } else if (len === 26) {
                        if (strno.length >= 4) {
                            const code = strno.slice(-4, -2).toUpperCase();
                            const suffixMap = {"KU": "U", "JC": "R", "OB": "B", "OP": "L", "OC": "M", "OL": "J", "KT": "N", "TP": "H"};
                            if (suffixMap[code]) {
                                if (abckz !== suffixMap[code]) {
                                    errors.push({ Rule: "R7_ABCKZ", Row: r._rowIndex, Message: `Len 26 (Code ${code}) harus ABCKZ='${suffixMap[code]}', tapi tertulis '${abckz}'` });
                                }
                            }
                        }
                    }

                    // --- NEW RULE: R12_WORK_CENTER_MATCH (AUTO MASTER) ---
                    // Using hardcoded MASTER_WC_CSV parsed into appState.workCenterData
                    if (appState.workCenterData && appState.workCenterData.size > 0) {
                        const stort = String(r.STORT || "").trim();
                        const arbpl = String(r.ARBPL || "").trim();
                        
                        // Check if STORT exists in our master map
                        if (stort && appState.workCenterData.has(stort)) {
                            const expectedArbpl = appState.workCenterData.get(stort);
                            if (arbpl !== expectedArbpl) {
                                errors.push({ 
                                    Rule: "R12_WORK_CENTER", 
                                    Row: r._rowIndex, 
                                    Message: `STORT '${stort}' requires ARBPL '${expectedArbpl}', but found '${arbpl}'` 
                                });
                            }
                        }
                    }
                });

                // --- NEW RULE 13: ANCHOR PID EXISTENCE ---
                // Logic: Anchor PID from filename must exist at least once in PLTXT column for rows where STRNO_LENGTH == 30 (Core)
                let anchorPidFound = false;
                for (const r of belowData) {
                    if (r.STRNO_LENGTH === 30) {
                        const p = String(r.PLTXT || "").toUpperCase().trim();
                        // Gunakan includes untuk pencarian parsial (antisipasi spasi/typo kecil)
                        if (p.includes(anchorPid)) {
                            anchorPidFound = true;
                            break; // Cukup ketemu sekali
                        }
                    }
                }

                if (!anchorPidFound) {
                    errors.push({
                        Rule: "R13_ANCHOR_MISSING",
                        Row: "GLOBAL",
                        Message: `Anchor PID '${anchorPid}' (dari Nama File) tidak ditemukan sama sekali pada data Core (STRNO 30, kolom PLTXT). Pastikan nama file sesuai isi.`
                    });
                }

                let segmentBuffer = [];
                for (let i = 0; i <= belowData.length; i++) {
                    const r = belowData[i];
                    const is30 = r && r.STRNO_LENGTH === 30;

                    if (is30) {
                        segmentBuffer.push({ idx: r._rowIndex, pltxt: r.PLTXT, strno: r.STRNO });
                    } else {
                        if (segmentBuffer.length > 0) {
                            const allEmpty = segmentBuffer.every(item => isEmpty(item.pltxt));
                            if (allEmpty) {
                                const startRow = segmentBuffer[0].idx;
                                const endRow = segmentBuffer[segmentBuffer.length-1].idx;
                                errors.push({ 
                                    Rule: "R6_SEGMENT_EMPTY", 
                                    Row: `${startRow}-${endRow}`, 
                                    Message: `Segmen Core (30) kosong semua tenant-nya. ${segmentBuffer[0].strno} ...` 
                                });
                            }
                        }
                        segmentBuffer = [];
                    }
                }

                let displayData = [];
                if (workbook.SheetNames.includes('display_ring')) {
                    const rawDisplay = XLSX.utils.sheet_to_json(workbook.Sheets['display_ring'], { defval: "" });
                    displayData = rawDisplay.map(r => {
                        const newRow = {};
                        // Keep ALL columns, just uppercase keys for consistency
                        Object.keys(r).forEach(k => newRow[k.toUpperCase().trim()] = r[k]);
                        return newRow;
                    });

                    // Variables for Rule 11 (PID Inconsistency) - REVISED SEGMENT-BASED LOGIC
                    let lastPidCounts = null; // { "PID1": count, "PID2": count }
                    let lastCableId = null;

                    const colsCheck = ["LINK_DESCRIPTION", "LINK_FRM_FLOC", "LINK_TO_FLOC", "FUNCTIONAL_LOCATION_LINK_OBJECT"];
                    displayData.forEach((r, i) => {
                        colsCheck.forEach(col => {
                            if (r[col]) { // Check if col exists in row
                                const val = String(r[col] || "").trim();
                                if (val && !seenStrno.has(val)) {
                                    errors.push({ 
                                        Rule: "R10_CROSS_CHECK", 
                                        Row: excelRow(i), 
                                        Message: `Sheet 'display_ring' kol '${col}': Nilai '${val}' tidak ditemukan di 'below_ring'.` 
                                    });
                                }
                            }
                        });

                        // --- OLD R19 REMOVED ---
                        // (Removed Intersection Check on display_ring as per update instructions)

                        const cableId = r['LINK_DESCRIPTION'];
                        if (cableId) {
                            const cores = belowData.filter(b => {
                                const s = String(b.STRNO || "");
                                const p = String(b.PLTXT || "");
                                // Filter core only (len 30), matches cable, and PLTXT is valid (not empty/KABEL)
                                return s.startsWith(cableId) && s.length >= 30 && p && p.trim() !== "";
                            });
                            
                            // Hitung core per PID untuk segmen ini
                            const currentPidCounts = {};
                            cores.forEach(c => {
                                const pid = c.PLTXT;
                                if (!pid.toUpperCase().includes("KABEL")) {
                                    currentPidCounts[pid] = (currentPidCounts[pid] || 0) + 1;
                                }
                            });

                            // --- NEW RULE 11 LOGIC: Segment-to-Segment Comparison ---
                            // Compare with previous row's calculation immediately
                            if (lastPidCounts) {
                                for (const pid in lastPidCounts) {
                                    // Check if PID exists in current segment (continuity check)
                                    // Rule: "Perbedaan antara core ... maka fail"
                                    if (currentPidCounts.hasOwnProperty(pid)) {
                                        const countLast = lastPidCounts[pid];
                                        const countCurr = currentPidCounts[pid];
                                        
                                        if (countLast !== countCurr) {
                                            errors.push({
                                                Rule: "R11_PID_CONSISTENCY",
                                                Row: excelRow(i),
                                                Message: `Inkonsistensi PID ${pid} antar Segmen: ${lastCableId} (${countLast} core) -> ${cableId} (${countCurr} core).`
                                            });
                                        }
                                    }
                                }
                            }

                            // Update state for next iteration
                            lastPidCounts = currentPidCounts;
                            lastCableId = cableId;
                        }
                    });

                    // --- NEW RULE 20: DISPLAY RING CONNECTIVITY CHAIN (Modified to Warning) ---
                    // Memastikan urutan kabel tidak terputus (Output Baris N-1 == Input Baris N)
                    for (let i = 1; i < displayData.length; i++) {
                        const prev = displayData[i - 1];
                        const curr = displayData[i];
                        
                        const prevTo = String(prev['LINK_TO_FUNCTIONAL_LOCATION_DESC'] || "").trim();
                        const currFrom = String(curr['LINK_FROM_FUNCTIONAL_LOCATION_DESC'] || "").trim();

                        if (prevTo !== currFrom) {
                            warnings.push({ // Changed to warnings as requested
                                Rule: "R20_DISPLAY_CHAIN",
                                Row: excelRow(i),
                                Message: `Chain Break: 'LINK_FROM_DESC' (${currFrom}) tidak menyambung dari 'LINK_TO_DESC' baris sebelumnya (${prevTo}).`
                            });
                        }
                    }
                }

                // --- FINAL STATUS DETERMINATION (Tiered Logic) ---
                let statusStr = "PASS";
                if (errors.length > 0) {
                    statusStr = "FAIL";
                } else if (warnings.length > 0) {
                    statusStr = "WARNING";
                }

                const isPass = (statusStr === "PASS");

                appState.stats.total++;
                if(statusStr === "PASS") {
                    appState.stats.pass++;
                    GameSystem.addXP(10, "Validation Passed");
                } else if (statusStr === "FAIL") {
                    appState.stats.fail++;
                } else {
                    appState.stats.warning++; // Increment Warning Stat
                }
                updateDashboardUI();

                const newWb = XLSX.utils.book_new();
                
                // --- CLEAN DATA FOR EXPORT (Remove STRNO_LENGTH and _rowIndex) ---
                const exportBelowData = belowData.map(r => {
                    const { STRNO_LENGTH, _rowIndex, ...rest } = r;
                    return rest;
                });

                const allKeys = Object.keys(exportBelowData[0]);
                const headerOrder = ['STRNO', ...allKeys.filter(k => k!=='STRNO')]; // STRNO first, others follow
                
                // --- Build SAP-ready TXT (TSV + CRLF) ---
                const sapTxt = buildSapTxtFromRows(exportBelowData, headerOrder);

                
                const wsBelow = XLSX.utils.json_to_sheet(exportBelowData, { header: headerOrder });
                XLSX.utils.book_append_sheet(newWb, wsBelow, "below_ring");

                if (displayData.length) {
                    const wsDisplay = XLSX.utils.json_to_sheet(displayData);
                    XLSX.utils.book_append_sheet(newWb, wsDisplay, "display_ring");
                }

                if (errors.length > 0) {
                    const wsErr = XLSX.utils.json_to_sheet(errors);
                    XLSX.utils.book_append_sheet(newWb, wsErr, "ERROR_LOG");
                }
                
                // Append Warnings to Log if any
                if (warnings.length > 0) {
                     const wsWarn = XLSX.utils.json_to_sheet(warnings);
                     XLSX.utils.book_append_sheet(newWb, wsWarn, "WARNING_LOG");
                }

                const summary = [
                    { ITEM: "STATUS", VALUE: statusStr },
                    { ITEM: "TOTAL_ERRORS", VALUE: errors.length },
                    { ITEM: "TOTAL_WARNINGS", VALUE: warnings.length },
                    { ITEM: "CHECKED_SHEETS", VALUE: "below_ring, display_ring" }
                ];
                const wsSum = XLSX.utils.json_to_sheet(summary);
                XLSX.utils.book_append_sheet(newWb, wsSum, "VALIDATION_SUMMARY");

                appState.processed[file.name] = {
                    fileName: file.name,
                    wb: newWb, 
                    belowData: belowData,
                    displayData: displayData,
                    pid: anchorPid, // Use the clean Anchor PID
                    status: statusStr,
                    errors: errors,
                    warnings: warnings, // Store warnings
                    sapTxt: sapTxt,
                    rowId: rowId,
                    isManuallyOverridden: false // New property for Force Status
                };
                
                appState.processedKeys = Object.keys(appState.processed);

                // Initial UI Render
                updateRowStatusUI(rowId, appState.processed[file.name]);
                updateTableRowVerifiedStatus(rowId, anchorPid);

                if (statusStr === "PASS") {
                     msgCell.innerHTML = "<span class='text-green-600 dark:text-green-400 font-medium'><i class='fa-solid fa-check-circle mr-1'></i> Validated Successfully</span>";
                } else if (statusStr === "WARNING") {
                     msgCell.innerHTML = `<span class='text-orange-600 dark:text-orange-400 font-medium'><i class='fa-solid fa-triangle-exclamation mr-1'></i> Found ${warnings.length} warnings</span>`;
                } else {
                     msgCell.innerHTML = `<span class='text-red-600 dark:text-red-400 font-medium'><i class='fa-solid fa-xmark mr-1'></i> Found ${errors.length} errors</span>`;
                }

                // Re-apply filter if active (to hide/show this new row)
                if(window.currentQueueFilter && window.currentQueueFilter !== 'all') {
                    filterQueueTable();
                } else if(document.getElementById('queueSearch').value.trim() !== "") {
                    filterQueueTable();
                }

            } catch (err) {
                console.error(err);
                statusCell.innerHTML = `<span class="bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300 py-1 px-3 rounded-md text-xs font-bold uppercase">Error</span>`;
                msgCell.innerText = err.message;
                verifiedCell.innerHTML = "-";
                actionCell.innerHTML = "-";
                appState.stats.total++;
                appState.stats.fail++;
                updateDashboardUI();
            }
        }

        function navigateFile(direction) {
            const newIndex = appState.currentFileIndex + direction;
            if (newIndex >= 0 && newIndex < appState.processedKeys.length) {
                const nextFileName = appState.processedKeys[newIndex];
                openVisualizer(nextFileName);
            }
        }

        function updateNavButtons() {
            const btnPrev = document.getElementById('btnModalPrev');
            const btnNext = document.getElementById('btnModalNext');
            
            btnPrev.disabled = appState.currentFileIndex <= 0;
            btnNext.disabled = appState.currentFileIndex >= appState.processedKeys.length - 1;
        }

        function openVisualizer(fileName) {
            const data = appState.processed[fileName];
            if (!data) return;

            appState.currentFileIndex = appState.processedKeys.indexOf(fileName);
            updateNavButtons();

            appState.targetPID = data.pid;
            document.getElementById('modalFileName').innerText = fileName;
            document.getElementById('targetPidDisplay').innerText = data.pid;
            
            updateVizStatusHeader(data);
            updateForceToggleButton(data);

            document.getElementById('vizModal').classList.remove('hidden');
            
            // Check verification status and update button
            updateVerifyButton(GameSystem.isVerified(data.pid));

            appState.currentData = data.belowData.map(r => ({
                strno: String(r.STRNO || ""),
                pltxt: String(r.PLTXT || ""),
                abckz: String(r.ABCKZ || ""),
                stort: String(r.STORT || ""), 
                arbpl: String(r.ARBPL || "")
            }));
            appState.filteredData = [...appState.currentData];
            appState.currentPage = 1;

            switchTab('viz');
            
            vizScale = 1.0;
            applyZoom();
            
            generateSVG(data.displayData, data.belowData, data.pid);
            renderDisplayRingTable(data.displayData);
            updatePaginationInfo();
            // Combine errors and warnings for display in modal
            const allIssues = [...data.errors, ...(data.warnings || [])];
            renderErrorTable(allIssues);
        }

        function renderDisplayRingTable(displayData) {
            const thead = document.getElementById('display-ring-head');
            const tbody = document.getElementById('display-ring-body');
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            if (!displayData || displayData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">No Data Available in display_ring</td></tr>';
                return;
            }

            // 1. Get All Keys (Columns) from first row
            const allKeys = Object.keys(displayData[0]);
            
            // 2. Filter out PID and RING_ID (Case Insensitive logic handled by UpperCase keys)
            const columns = allKeys.filter(k => k !== 'PID' && k !== 'RING_ID');

            // 3. Render Header
            let headerHTML = '<tr>';
            columns.forEach(col => {
                headerHTML += `<th class="px-4 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider sticky-header border-b border-gray-100 dark:border-gray-800">${col.replace(/_/g, ' ')}</th>`;
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;

            // 4. Render Body
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition";
                let rowHTML = '';
                columns.forEach(col => {
                    rowHTML += `<td class="px-4 py-2 border-b border-gray-50 dark:border-gray-800 text-slate-600 dark:text-gray-300 whitespace-nowrap">${row[col] || '-'}</td>`;
                });
                tr.innerHTML = rowHTML;
                tbody.appendChild(tr);
            });
        }

        function renderErrorTable(errors) {
            const tbody = document.getElementById('error-table-body');
            const badge = document.getElementById('error-badge');
            const countDisplay = document.getElementById('error-count-display');
            
            tbody.innerHTML = '';
            
            if(!errors || errors.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-12 text-center text-gray-400 italic"><i class="fa-solid fa-check-circle text-4xl text-green-100 mb-2 block"></i>No validation issues found</td></tr>`;
                badge.classList.add('hidden');
                badge.innerText = '0';
                countDisplay.innerText = '0 Issues Found';
                countDisplay.className = "text-xs bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-300 px-3 py-1 rounded-full font-medium";
                return;
            }

            badge.classList.remove('hidden');
            badge.innerText = errors.length;
            countDisplay.innerText = `${errors.length} Issues Found`;
            countDisplay.className = "text-xs bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-300 px-3 py-1 rounded-full font-medium";

            errors.forEach(err => {
                const tr = document.createElement('tr');
                // Color code warnings vs errors
                // NEW: Also check for R20_DISPLAY_CHAIN
                const isWarning = (err.Rule === "R18_HIGH_OCCUPANCY" || err.Rule === "R20_DISPLAY_CHAIN");
                const rowClass = isWarning ? "hover:bg-orange-50 dark:hover:bg-orange-900/10" : "hover:bg-red-50 dark:hover:bg-red-900/10";
                const textClass = isWarning ? "text-orange-600 dark:text-orange-400" : "text-red-600 dark:text-red-400";

                tr.className = `${rowClass} transition border-b border-gray-100 dark:border-gray-800`;
                tr.innerHTML = `
                    <td class="px-6 py-3 text-sm font-mono text-slate-500 dark:text-gray-400">${err.Row}</td>
                    <td class="px-6 py-3 text-sm font-bold ${textClass}">${err.Rule}</td>
                    <td class="px-6 py-3 text-sm text-slate-700 dark:text-gray-300">${err.Message}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    // ... (Remaining scripts for Viz SVG Generation, Batcher, and Converter logic remain EXACTLY unchanged) ...
        function switchTab(tab) {
            const btnViz = document.getElementById('tab-viz');
            const btnDisplay = document.getElementById('tab-display');
            const btnData = document.getElementById('tab-data');
            const btnErrors = document.getElementById('tab-errors');
            
            const divViz = document.getElementById('content-viz');
            const divDisplay = document.getElementById('content-display');
            const divData = document.getElementById('content-data');
            const divErrors = document.getElementById('content-errors');

            // Reset Styles
            [btnViz, btnDisplay, btnData, btnErrors].forEach(btn => {
                btn.className = "nav-btn py-4 text-sm font-medium text-gray-500 hover:text-slate-800 dark:text-gray-400 dark:hover:text-white transition whitespace-nowrap";
                btn.classList.remove('active', 'text-mitratel-red', 'font-semibold');
            });
            [divViz, divDisplay, divData, divErrors].forEach(div => div.classList.add('hidden'));

            // Activate Selected
            let activeBtn;
            if (tab === 'viz') {
                activeBtn = btnViz;
                divViz.classList.remove('hidden');
            } else if (tab === 'display') {
                activeBtn = btnDisplay;
                divDisplay.classList.remove('hidden');
            } else if (tab === 'data') {
                activeBtn = btnData;
                divData.classList.remove('hidden');
                renderTablePage();
                updatePaginationInfo(); 
            } else if (tab === 'errors') {
                activeBtn = btnErrors;
                divErrors.classList.remove('hidden');
            }

            activeBtn.classList.add('active', 'text-mitratel-red', 'font-semibold');
            activeBtn.classList.remove('text-gray-500');
        }

        // --- NEW: LEN FILTER HANDLER ---
        function setLenFilter(len) {
            appState.currentLenFilter = len;
            // Update Button Styles
            ['all', '17', '21', '26', '30'].forEach(l => {
                const btn = document.getElementById(`len-btn-${l}`);
                if(l === len) {
                    btn.className = "px-3 py-1.5 text-xs font-bold rounded-lg bg-mitratel-red text-white transition shadow-sm whitespace-nowrap";
                } else {
                    btn.className = "px-3 py-1.5 text-xs font-bold rounded-lg bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 transition whitespace-nowrap";
                }
            });
            filterTable();
        }

        function filterTable() {
            const term = document.getElementById('tableSearch').value.toLowerCase();
            const lenFilter = appState.currentLenFilter;

            appState.filteredData = appState.currentData.filter(row => {
                // Text Search
                const matchesText = row.strno.toLowerCase().includes(term) || 
                                    row.pltxt.toLowerCase().includes(term) ||
                                    row.stort.toLowerCase().includes(term) || 
                                    row.arbpl.toLowerCase().includes(term);

                // Length Filter
                let matchesLen = true;
                if (lenFilter !== 'all') {
                    matchesLen = (row.strno.length === parseInt(lenFilter));
                }

                return matchesText && matchesLen;
            });

            appState.currentPage = 1;
            renderTablePage();
            updatePaginationInfo();
        }

        function changePage(delta) {
            const maxPage = Math.ceil(appState.filteredData.length / appState.rowsPerPage);
            const newPage = appState.currentPage + delta;
            if (newPage >= 1 && newPage <= maxPage) {
                appState.currentPage = newPage;
                renderTablePage();
                updatePaginationInfo(); // FIX: Added missing call here
            }
        }

        function updatePaginationInfo() {
            const total = appState.filteredData.length;
            const start = total === 0 ? 0 : (appState.currentPage - 1) * appState.rowsPerPage + 1;
            const end = Math.min(appState.currentPage * appState.rowsPerPage, total);
            
            document.getElementById('totalRows').innerText = total;
            document.getElementById('showStart').innerText = start;
            document.getElementById('showEnd').innerText = end;
            document.getElementById('pageIndicator').innerText = `Page ${appState.currentPage}`;
            
            document.getElementById('btnPrev').disabled = appState.currentPage === 1;
            document.getElementById('btnPrev').classList.toggle('opacity-50', appState.currentPage === 1);
            
            const maxPage = Math.ceil(total / appState.rowsPerPage);
            document.getElementById('btnNext').disabled = appState.currentPage >= maxPage;
            document.getElementById('btnNext').classList.toggle('opacity-50', appState.currentPage >= maxPage);
        }

        function renderTablePage() {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = "";
            const startIdx = (appState.currentPage - 1) * appState.rowsPerPage;
            const pageData = appState.filteredData.slice(startIdx, startIdx + appState.rowsPerPage);

            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="py-8 text-center text-gray-400 italic">No data found matching your search</td></tr>`;
                return;
            }

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                const isMatch = appState.targetPID && row.pltxt.includes(appState.targetPID);
                if(isMatch) tr.classList.add('row-highlight');
                tr.innerHTML = `
                    <td class="py-2 px-6 text-sm font-mono text-slate-600 dark:text-gray-300">${row.strno}</td>
                    <td class="py-2 px-6 text-sm text-slate-800 dark:text-white font-medium">${row.abckz}</td>
                    <td class="py-2 px-6 text-sm ${isMatch ? 'font-bold text-mitratel-red' : 'text-slate-800 dark:text-white'}">${row.pltxt || '-'}</td>
                    <td class="py-2 px-6 text-sm text-slate-500 dark:text-gray-400">${row.stort || '-'}</td>
                    <td class="py-2 px-6 text-sm text-slate-500 dark:text-gray-400">${row.arbpl || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function generateSVG(displayData, belowData, targetPID) {
            const container = document.getElementById('viz-scale-container');
            container.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><span class="loader mb-4"></span><p class="text-sm text-gray-500">Generating Topology...</p></div>';

            // --- FIXED: SVG PATHS (Replaces unreliable Fonts) ---
            const iconPaths = {
                network: "M64 32C28.7 32 0 60.7 0 96v256c0 35.3 28.7 64 64 64h128v64H128c-17.7 0-32 14.3-32 32s14.3 32 32 32h256c17.7 0 32-14.3 32-32s-14.3-32-32-32H320v-64h128c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM32 96c0-17.7 14.3-32 32-32h448c17.7 0 32 14.3 32 32v256c0 17.7-14.3 32 32 32H64c-17.7 0-32-14.3-32-32V96z",
                circleDot: "M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-352a96 96 0 1 1 0 192 96 96 0 1 1 0-192z",
                box: "M32 32H288c17.7 0 32 14.3 32 32V96c0 17.7-14.3 32-32 32H32C14.3 128 0 113.7 0 96V64C0 46.3 14.3 32 32 32zm0 128H288V416c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V160z",
                plug: "M0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z M188.3 147.1c-7.6 4.2-12.3 12.3-12.3 20.9V344c0 8.7 4.7 16.7 12.3 20.9s16.8 4.1 24.3-.5l144-88c7.1-4.4 11.5-12.1 11.5-20.5s-4.4-16.1-11.5-20.5l-144-88c-7.4-4.5-16.7-4.7-24.3-.5z", // Actually triangle play for generic
                circle: "M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512z"
            };

            // --- 1. Helper Styles with Path Logic ---
            const getNodeStyle = (type, label) => {
                const t = (type || "").toUpperCase();
                const l = (label || "").toUpperCase();
                
                // OTB/ODF (Insert Site/Termination) - Kotak (Server/Network)
                if (t.includes("OTB") || l.includes("OTB")) 
                    return { shape: "rect", fill: "#fffbeb", stroke: "#d97706", text: "#b45309", iconPath: iconPaths.network }; 
                
                // Closure (Sambungan) - Lingkaran (Circle Dot)
                if (t.includes("CLOSURE") || l.includes("CLOSURE") || l.includes("JC")) 
                    return { shape: "circle", fill: "#ffffff", stroke: "#1e293b", text: "#0f172a", iconPath: iconPaths.circleDot }; 
                
                // FDT/FAT - Hexagon (Box Archive)
                if (t.includes("FDT") || l.includes("FDT") || t.includes("FAT")) 
                    return { shape: "hexagon", fill: "#e0f2fe", stroke: "#0284c7", text: "#0369a1", iconPath: iconPaths.box }; 
                
                // ODP/Distribution Point
                if (t.includes("ODP") || l.includes("ODP"))
                    return { shape: "circle", fill: "#f0fdf4", stroke: "#15803d", text: "#166534", iconPath: iconPaths.plug }; 

                // Default
                return { shape: "circle", fill: "#ffffff", stroke: "#64748b", text: "#334155", iconPath: iconPaths.circle }; 
            };

            setTimeout(() => {
                const nodeMap = new Map(); // id -> Node Object
                const edges = [];
                let currentX = 100;
                const spacing = 350; // Increased spacing for cable boxes
                const yPos = 300;

                // Check actual dark mode status at render time
                const isDark = document.documentElement.classList.contains('dark');

                // --- 2. Data Parsing & Graph Building ---
                displayData.forEach((row, idx) => {
                    const parse = (floc, desc, type) => {
                        if (!floc) return { span: "UNK", mat: "UNK", id: "UNK", type: "UNK" };
                        
                        const parts = floc.split('-');
                        // Mencari Span ID (Sxxx)
                        let span = parts.find(p => p.startsWith('S') && p.length <= 4 && !isNaN(p.substring(1))) || "UNK";
                        
                        // Fallback Span from Desc if present
                        if(span === "UNK" && desc && desc.includes("-S")) {
                             const dParts = desc.split('-');
                             const dSpan = dParts.find(p => p.startsWith('S') && !isNaN(p.substring(1)));
                             if(dSpan) span = dSpan;
                        }

                        let mat = desc ? desc : parts.pop();
                        return { span, mat, id: floc, type: type || "GENERIC" };
                    };

                    const uData = parse(row['LINK_FRM_FLOC'], row['LINK_FROM_FUNCTIONAL_LOCATION_DESC'], row['FROM_OBJECT_NODE_TYPE']);
                    const vData = parse(row['LINK_TO_FLOC'], row['LINK_TO_FUNCTIONAL_LOCATION_DESC'], row['TO_OBJECT_NODE_TYPE']);

                    // Node Layout Logic
                    let uNode = nodeMap.get(uData.id);
                    let vNode = nodeMap.get(vData.id);

                    if (!uNode) {
                        uNode = { ...uData, x: currentX, y: yPos };
                        nodeMap.set(uData.id, uNode);
                        currentX += spacing;
                    }

                    if (!vNode) {
                        vNode = { ...vData, x: uNode.x + spacing, y: yPos };
                        nodeMap.set(vData.id, vNode);
                        // Update global X to ensure next sequence doesn't overlap
                        if(vNode.x >= currentX) currentX = vNode.x + spacing;
                    }

                    // Process Cores/Tenants
                    const cableId = row['LINK_DESCRIPTION'];
                    // --- REVISI: Ambil semua baris yang dimulai dengan ID Kabel ---
                    const cableRows = belowData.filter(b => String(b.STRNO || "").startsWith(cableId));

                    // --- REVISI: Logika Okupansi Core (Hanya yang memiliki PID/PLTXT) ---
                    // Menghitung core yang memiliki nilai pada kolom PLTXT (PID/Project) dan bukan data sampah/kabel
                    const occupiedCores = cableRows.filter(r => {
                        const p = String(r.PLTXT || "").trim();
                        // PLTXT tidak kosong dan bukan string "KABEL" (metadata)
                        return p.length > 0 && !p.toUpperCase().includes("KABEL");
                    });
                    
                    // --- PIDs Extraction (Tetap ambil dari cableRows untuk daftar aset lengkap) ---
                    // Mengambil PID unik dari semua baris terkait kabel, kecuali yang mengandung kata "KABEL"
                    const uniquePids = [...new Set(cableRows.map(c => c.PLTXT))].filter(p => 
                        p && p.trim() !== "" && !p.toUpperCase().includes("KABEL")
                    );

                    // Extract Segment Name
                    // Logic: Find pattern "Sxxx-xxx" in fullCableId (e.g. S10-020 from R04...S10-020-JC01)
                    let segmentName = "SEG";
                    const segMatch = cableId ? cableId.match(/S\d+-\d+/) : null;
                    if (segMatch) {
                        segmentName = segMatch[0];
                    } else {
                        // Fallback: try to grab last numeric part if S-pattern fails
                        const parts = cableId ? cableId.split('-') : [];
                        if (parts.length > 2) {
                             // Attempt to construct something meaningful like S10-020
                             // This depends heavily on naming convention consistency
                             segmentName = parts.slice(-3, -1).join('-'); // Last 2 parts before type?
                        }
                    }

                    edges.push({
                        source: uData.id,
                        target: vData.id,
                        cableId: cableId ? cableId.split('-').pop() : "UNK", // Short Label
                        fullCableId: cableId,
                        segmentName: segmentName,
                        pids: uniquePids,
                        usedCores: occupiedCores.length // Gunakan hasil hitungan baru
                    });
                });

                if (nodeMap.size === 0) {
                    container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-400"><i class="fa-solid fa-circle-exclamation text-4xl mb-2"></i><p>No Topology Data Found</p></div>';
                    return;
                }

                // --- 3. Identify Intersections (Nodes between different Spans) ---
                const nodesArr = Array.from(nodeMap.values());
                // Group by Span to calculate Bounding Boxes
                const spans = {};
                
                nodesArr.forEach(n => {
                    if(n.span !== "UNK") {
                        if (!spans[n.span]) spans[n.span] = { min: n.x, max: n.x, nodes: [] };
                        else {
                            spans[n.span].min = Math.min(spans[n.span].min, n.x);
                            spans[n.span].max = Math.max(spans[n.span].max, n.x);
                        }
                        spans[n.span].nodes.push(n);
                    }
                });

                const width = Math.max(...nodesArr.map(n => n.x)) + 300;
                const height = 900; 

                let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg" class="font-sans">`;
                
                svg += `
                <defs>
                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="32" refY="3" orient="auto">
                        <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                    </marker>
                    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.1"/>
                    </filter>
                </defs>`;

                // --- 4. Draw Span Backgrounds (Behind everything) ---
                const spanBgColors = isDark ? ['#1e293b', '#0f172a'] : ['#f8fafc', '#f1f5f9'];
                const spanTextColor = isDark ? '#94a3b8' : '#64748b';

                Object.keys(spans).sort().forEach((s, i) => {
                    const g = spans[s];
                    const pad = 100;
                    
                    const rectX = g.min - pad;
                    const rectW = (g.max - g.min) + (pad * 2);
                    
                    // COMPACT RESIZE: Adjust Y and Height
                    // Nodes are at yPos = 300.
                    // We want box from ~180 to ~450 (height ~270)
                    const rectY = yPos - 120; // 180
                    const rectH = 280; 
                    
                    // Span Label
                    svg += `<text x="${rectX + rectW/2}" y="${rectY - 20}" text-anchor="middle" font-weight="bold" fill="${spanTextColor}" font-size="20" style="text-transform:uppercase; letter-spacing: 2px;">SPAN ${s}</text>`;
                    
                    // Span Box
                    svg += `<rect x="${rectX}" y="${rectY}" width="${rectW}" height="${rectH}" fill="${spanBgColors[i % 2]}" rx="20" stroke="${isDark?'#334155':'#e2e8f0'}" stroke-width="2" stroke-dasharray="10,5" />`;
                });

                // --- 5. Draw Edges (Cables) ---
                edges.forEach(e => {
                    const u = nodeMap.get(e.source);
                    const v = nodeMap.get(e.target);
                    const midX = (u.x + v.x) / 2;
                    const midY = (u.y + v.y) / 2;

                    // Main Cable Line
                    svg += `<line x1="${u.x}" y1="${u.y}" x2="${v.x}" y2="${v.y}" stroke="#94a3b8" stroke-width="4" marker-end="url(#arrow)" />`;

                    // Segment Name Label (Above Line)
                    // COLOR FIX: Make segment name lighter/brighter in dark mode
                    const segmentColor = isDark ? '#e2e8f0' : '#64748b';
                    if (e.segmentName) {
                        svg += `<text x="${midX}" y="${midY - 65}" text-anchor="middle" font-size="12" font-weight="bold" fill="${segmentColor}" style="letter-spacing: 1px;">${e.segmentName}</text>`;
                    }

                    // Cable ID Box (Intersection visualizer)
                    const cableLabelColor = targetPID && e.fullCableId.includes(targetPID) ? "#EE2E24" : "#475569";
                    const boxFill = isDark ? '#1e293b' : 'white';
                    
                    svg += `<rect x="${midX - 50}" y="${midY - 50}" width="100" height="24" fill="${boxFill}" stroke="${cableLabelColor}" stroke-width="1.5" rx="6" filter="url(#shadow)" />`;
                    svg += `<text x="${midX}" y="${midY - 34}" text-anchor="middle" font-size="11" font-weight="bold" fill="${cableLabelColor}">${e.cableId}</text>`;

                    // --- Tenant List / Cores Box ---
                    const pids = e.pids.length ? e.pids : ["-"];
                    // REVISED HEIGHT CALCULATION: Header + Rows + Footer
                    const headerHeight = 30;
                    const rowHeight = 16;
                    const footerHeight = 24; // Space for "Used Cores: X"
                    const listHeight = headerHeight + (pids.length * rowHeight) + footerHeight;
                    const listY = midY + 25;
                    
                    // Box
                    svg += `<rect x="${midX - 80}" y="${listY}" width="160" height="${listHeight}" class="pid-box" filter="url(#shadow)" />`;
                    
                    // Header (Brighten for Dark Mode)
                    const headerColor = isDark ? '#4ade80' : '#15803d'; // Neon Green for dark mode
                    svg += `<text x="${midX}" y="${listY + 18}" text-anchor="middle" font-size="10" font-weight="bold" fill="${headerColor}" style="text-decoration: underline">ASSETS</text>`;

                    // PIDs
                    pids.forEach((pid, idx) => {
                        // --- REVISI HIGHLIGHT PID: Case Insensitive ---
                        // Mencocokkan nama file (targetPID) dengan PID di dalam box secara case-insensitive
                        const pNorm = pid.toUpperCase();
                        const tNorm = targetPID ? targetPID.toUpperCase() : "";
                        const isMatch = tNorm && pNorm.includes(tNorm);

                        const color = isMatch ? "#EE2E24" : (isDark ? "#cbd5e1" : "#334155");
                        const weight = isMatch ? "bold" : "normal";
                        // Warna Highlight Kuning/Oranye (Sesuai v13)
                        const bg = isMatch ? (isDark ? "#450a0a" : "#FEF2F2") : "none";
                        
                        if (isMatch) {
                            svg += `<rect x="${midX - 75}" y="${listY + 24 + (idx*rowHeight)}" width="150" height="16" fill="${bg}" rx="3" />`;
                        }
                        
                        let displayPid = pid.replace(/\(R\)/gi, ' [R]').replace(/\(r\)/gi, ' [R]');
                        if(displayPid.length > 20) displayPid = displayPid.substring(0, 18) + '..';
                        
                        svg += `<text x="${midX}" y="${listY + 36 + (idx*rowHeight)}" text-anchor="middle" font-size="10" fill="${color}" font-weight="${weight}" font-family="monospace">${displayPid}</text>`;
                    });

                    // Footer (Okupansi Core) - REVISI LABEL
                    const footerY = listY + headerHeight + (pids.length * rowHeight) + 14;
                    const footerLineColor = isDark ? '#374151' : '#e2e8f0';
                    const footerTextColor = isDark ? '#9ca3af' : '#64748b'; // Gray-400 : Slate-500
                    
                    svg += `<line x1="${midX - 70}" y1="${footerY - 10}" x2="${midX + 70}" y2="${footerY - 10}" stroke="${footerLineColor}" stroke-width="1" stroke-dasharray="3,3" />`;
                    svg += `<text x="${midX}" y="${footerY}" text-anchor="middle" font-size="9" font-weight="bold" fill="${footerTextColor}">Okupansi Core: ${e.usedCores}</text>`;
                });

                // --- 6. Draw Nodes (Materials/Sites) ---
                nodesArr.forEach(n => {
                    const style = getNodeStyle(n.type, n.mat);
                    const isIntersection = (n.mat.includes("OTB") || n.mat.includes("ODF")); 
                    
                    const size = isIntersection ? 70 : 50; 
                    const iconSize = isIntersection ? 24 : 18;
                    const offset = size / 2;

                    // Shape Drawing
                    if (style.shape === 'rect') {
                        svg += `<rect x="${n.x - offset}" y="${n.y - offset}" width="${size}" height="${size}" fill="${style.fill}" stroke="${style.stroke}" stroke-width="3" rx="10" filter="url(#shadow)" />`;
                    } else if (style.shape === 'hexagon') {
                        const r = size / 1.7;
                        const hexPath = `M${n.x + r*Math.cos(0)} ${n.y + r*Math.sin(0)} ` +
                                        `L${n.x + r*Math.cos(Math.PI/3)} ${n.y + r*Math.sin(Math.PI/3)} ` +
                                        `L${n.x + r*Math.cos(2*Math.PI/3)} ${n.y + r*Math.sin(2*Math.PI/3)} ` +
                                        `L${n.x + r*Math.cos(Math.PI)} ${n.y + r*Math.sin(Math.PI)} ` +
                                        `L${n.x + r*Math.cos(4*Math.PI/3)} ${n.y + r*Math.sin(4*Math.PI/3)} ` +
                                        `L${n.x + r*Math.cos(5*Math.PI/3)} ${n.y + r*Math.sin(5*Math.PI/3)} Z`;
                        svg += `<path d="${hexPath}" fill="${style.fill}" stroke="${style.stroke}" stroke-width="3" filter="url(#shadow)" />`;
                    } else {
                        svg += `<circle cx="${n.x}" cy="${n.y}" r="${size/2}" fill="${style.fill}" stroke="${style.stroke}" stroke-width="3" filter="url(#shadow)" />`;
                    }

                    // --- REPLACED: Icon Drawing using Path instead of Text Font ---
                    const scaleFactor = 0.04; // Scale 512px path to approx 20px
                    const scaledIconSize = 512 * scaleFactor;
                    const translateX = n.x - (scaledIconSize / 2);
                    const translateY = n.y - (scaledIconSize / 2);

                    svg += `<g transform="translate(${translateX}, ${translateY}) scale(${scaleFactor})">
                                <path d="${style.iconPath}" fill="${style.text}" />
                            </g>`;

                    // Labels
                    svg += `<text x="${n.x}" y="${n.y - offset - 15}" text-anchor="middle" font-size="12" font-weight="bold" fill="${isDark?'#94a3b8':'#475569'}">${n.span}</text>`;
                    
                    let label = n.mat;
                    if(label.length > 20) label = label.substring(0, 18) + '..';
                    
                    // COLOR FIX: More distinctive white in dark mode for Node Names + Shadow
                    const labelColor = isDark ? '#ffffff' : '#1e293b';
                    const textShadow = isDark ? 'style="text-shadow: 0px 1px 3px rgba(0,0,0,0.8);"' : ''; 
                    
                    svg += `<text x="${n.x}" y="${n.y + offset + 20}" text-anchor="middle" font-size="11" font-weight="bold" fill="${labelColor}" ${textShadow}>${label}</text>`;
                });

                svg += `</svg>`;
                container.innerHTML = svg;

            }, 200);
        }
    
        // --- Main tab switching (Validator vs Converter) ---
        (function setupMainTabs() {
            const btnV = document.getElementById('tabBtnValidator');
            const btnB = document.getElementById('tabBtnBatcher');
            const btnC = document.getElementById('tabBtnConverter');
            const tabV = document.getElementById('tab-validator');
            const tabB = document.getElementById('tab-batcher');
            const tabC = document.getElementById('tab-converter');

            if (!btnV || !btnB || !btnC || !tabV || !tabB || !tabC) return;

            function setActive(which) {
                const isV = which === 'validator';
                const isB = which === 'batcher';
                const isC = which === 'converter';
                
                tabV.classList.toggle('hidden', !isV);
                tabB.classList.toggle('hidden', !isB);
                tabC.classList.toggle('hidden', !isC);

                // Helper to set style
                const setStyle = (btn, active) => {
                    if(active) {
                        btn.classList.add('bg-gray-50', 'text-slate-900', 'shadow-sm', 'dark:bg-gray-700', 'dark:text-white');
                        btn.classList.remove('text-slate-500', 'hover:text-slate-900', 'dark:text-gray-400', 'dark:hover:text-white');
                    } else {
                        btn.classList.add('text-slate-500', 'hover:text-slate-900', 'dark:text-gray-400', 'dark:hover:text-white');
                        btn.classList.remove('bg-gray-50', 'text-slate-900', 'shadow-sm', 'dark:bg-gray-700', 'dark:text-white');
                    }
                };

                setStyle(btnV, isV);
                setStyle(btnB, isB);
                setStyle(btnC, isC);
            }

            btnV.addEventListener('click', () => setActive('validator'));
            btnB.addEventListener('click', () => setActive('batcher'));
            btnC.addEventListener('click', () => setActive('converter'));
        })();

        // --- BATCHER LOGIC (NEW FEATURE) ---
        (function setupBatcher() {
            const masterInput = document.getElementById('batchMasterInput');
            const folderInput = document.getElementById('batchFolderInput');

            masterInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                batcherState.targetFiles.clear();
                let targets = [];

                if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                    const text = await file.text();
                    // Assuming comma, semi-colon or newline separated
                    const lines = text.split(/[\r\n]+/);
                    lines.forEach(line => {
                         // Simple heuristic: take first non-empty token
                         const token = line.split(/[;,]/)[0].trim();
                         if(token) targets.push(token);
                    });
                } else {
                    const ab = await file.arrayBuffer();
                    const wb = XLSX.read(ab, {type: 'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    // Assuming column A is the target filename
                    const data = XLSX.utils.sheet_to_json(ws, {header: 1});
                    data.forEach(row => {
                        if(row[0]) targets.push(String(row[0]).trim());
                    });
                }
                
                targets.forEach(t => batcherState.targetFiles.add(normalizeName(t)));
                
                document.getElementById('masterCount').innerText = batcherState.targetFiles.size;
                document.getElementById('masterListStat').classList.remove('hidden');
            });

            folderInput.addEventListener('change', (e) => {
                batcherState.folderMap.clear();
                const files = Array.from(e.target.files);
                
                // Indexing logic
                files.forEach(f => {
                    if(f.name.match(/\.(xls|xlsx)$/i) && !f.name.startsWith("~$")) {
                        const key = normalizeName(f.name);
                        batcherState.folderMap.set(key, f);
                    }
                });

                document.getElementById('folderCount').innerText = batcherState.folderMap.size;
                document.getElementById('folderStat').classList.remove('hidden');
            });

            function normalizeName(name) {
                // Remove extension and common clutter
                return name.replace(/\.(xlsx|xls|csv)$/i, '').trim().toUpperCase();
            }

            // Expose function globally for HTML onclick
            window.runBatchMatching = function() {
                if (batcherState.targetFiles.size === 0) {
                    alert("Please upload a Master List first.");
                    return;
                }
                if (batcherState.folderMap.size === 0) {
                    alert("Please select a Source Folder first.");
                    return;
                }

                const batchSize = parseInt(document.getElementById('batchSizeInput').value) || 50;
                const foundFiles = [];
                batcherState.missingFiles = []; // Reset missing list
                let missing = 0;

                // Checking Match
                batcherState.targetFiles.forEach(target => {
                    if (batcherState.folderMap.has(target)) {
                        foundFiles.push(batcherState.folderMap.get(target));
                    } else {
                        missing++;
                        batcherState.missingFiles.push(target);
                    }
                });

                // Update Stats
                document.getElementById('matchCount').innerText = foundFiles.length;
                document.getElementById('missingCount').innerText = missing;
                batcherState.matchCount = foundFiles.length;
                batcherState.missingCount = missing;

                // Show "View Missing" button if there are missing files
                if (missing > 0) {
                    document.getElementById('btnViewMissing').classList.remove('hidden');
                } else {
                    document.getElementById('btnViewMissing').classList.add('hidden');
                }

                // Create Batches
                batcherState.batches = [];
                for (let i = 0; i < foundFiles.length; i += batchSize) {
                    batcherState.batches.push(foundFiles.slice(i, i + batchSize));
                }

                document.getElementById('batchCountDisplay').innerText = batcherState.batches.length;
                renderBatchList();
                
                // Toggle "Send All" and "Download Manifest" buttons
                if(foundFiles.length > 0) {
                     document.getElementById('btnSendAllBatch').classList.remove('hidden');
                     document.getElementById('btnDownloadManifest').classList.remove('hidden');
                } else {
                     document.getElementById('btnSendAllBatch').classList.add('hidden');
                     // If there are missing files but no matches, we still want to allow downloading the report (for the missing part)
                     if(missing === 0) {
                         document.getElementById('btnDownloadManifest').classList.add('hidden');
                     } else {
                         document.getElementById('btnDownloadManifest').classList.remove('hidden');
                     }
                }
            };

            window.viewMissingFiles = function() {
                const listContainer = document.getElementById('missingFilesList');
                listContainer.innerHTML = '';
                
                batcherState.missingFiles.forEach(name => {
                    const li = document.createElement('li');
                    li.className = "border-b border-gray-100 dark:border-gray-800 last:border-0 py-1";
                    li.textContent = name;
                    listContainer.appendChild(li);
                });
                
                document.getElementById('missingFilesModal').classList.remove('hidden');
            };

            window.downloadBatchManifest = function() {
                const wb = XLSX.utils.book_new();

                // 1. Summary Sheet
                const summaryData = [
                    { Metric: "Total Targets (Master List)", Value: batcherState.targetFiles.size },
                    { Metric: "Total Files in Folder", Value: batcherState.folderMap.size },
                    { Metric: "Matches Found", Value: batcherState.matchCount },
                    { Metric: "Missing Items", Value: batcherState.missingCount },
                    { Metric: "Batches Created", Value: batcherState.batches.length }
                ];
                const wsSummary = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

                // 2. Batch Details Sheet
                const batchRows = [];
                batcherState.batches.forEach((batch, batchIdx) => {
                    batch.forEach(file => {
                        batchRows.push({
                            Batch_Number: batchIdx + 1,
                            File_Name: file.name,
                            Size_KB: (file.size / 1024).toFixed(2)
                        });
                    });
                });
                if(batchRows.length > 0) {
                    const wsBatches = XLSX.utils.json_to_sheet(batchRows);
                    XLSX.utils.book_append_sheet(wb, wsBatches, "Batch_Distribution");
                }

                // 3. Missing Files Sheet
                if(batcherState.missingFiles.length > 0) {
                    const missingRows = batcherState.missingFiles.map(f => ({ Missing_PID: f }));
                    const wsMissing = XLSX.utils.json_to_sheet(missingRows);
                    XLSX.utils.book_append_sheet(wb, wsMissing, "Missing_Items");
                }

                XLSX.writeFile(wb, "Batch_Processing_Report.xlsx");
            };

            function renderBatchList() {
                const container = document.getElementById('batchListContainer');
                container.innerHTML = '';

                if (batcherState.batches.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-10 italic">No matches found based on current inputs.</div>';
                    return;
                }

                batcherState.batches.forEach((batch, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex justify-between items-center shadow-sm hover:shadow-md transition";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-300 flex items-center justify-center font-bold text-xs">
                                ${index + 1}
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-slate-700 dark:text-gray-200">Batch #${index + 1}</h4>
                                <p class="text-xs text-gray-400">${batch.length} files</p>
                            </div>
                        </div>
                        <button onclick="sendBatchToValidator(${index})" class="bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-300 text-xs font-semibold px-3 py-1.5 rounded border border-blue-100 dark:border-blue-900/30 transition">
                            Process <i class="fa-solid fa-arrow-right ml-1"></i>
                        </button>
                    `;
                    container.appendChild(div);
                });
            }

            window.sendBatchToValidator = function(batchIndex) {
                let filesToSend = [];
                if (batchIndex === 'all') {
                    if(!confirm("Are you sure you want to process ALL " + batcherState.matchCount + " files? This might take a while.")) return;
                    // Flatten all batches
                    batcherState.batches.forEach(b => filesToSend.push(...b));
                } else {
                    filesToSend = batcherState.batches[batchIndex];
                }

                if (!filesToSend || filesToSend.length === 0) return;

                // 1. Switch Tab
                document.getElementById('tabBtnValidator').click();
                
                // 2. Trigger Handle Files Logic
                handleFiles(filesToSend);
                
                showToast(`Transferred ${filesToSend.length} files to Validator Queue`, 'success');
            };

        })();

    </script>
<!-- Converter Script (UNCHANGED) -->
<script>
(function(){
'use strict';
// UI Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileCountSpan = document.getElementById('fileCount');
        const convertBtn = document.getElementById('convertBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusLog = document.getElementById('statusLog');
        const modeInputs = document.querySelectorAll('input[name="outputMode"]');
        const filenameContainer = document.getElementById('filenameContainer');
        const customFilenameInput = document.getElementById('customFilename');
        const dropIcon = document.getElementById('dropIcon');
        const acceptText = document.getElementById('acceptText');
        
        // Mode Switchers
        const modeExcelBtn = document.getElementById('modeExcel');
        const modeTextBtn = document.getElementById('modeText');
        
        // State
        let filesToProcess = [];
        let currentInputMode = 'excel'; // 'excel' or 'text'

        // --- Event Listeners for Source Switching ---
        modeExcelBtn.addEventListener('click', () => switchSourceMode('excel'));
        modeTextBtn.addEventListener('click', () => switchSourceMode('text'));

        function switchSourceMode(mode) {
            currentInputMode = mode;
            filesToProcess = [];
            updateUI();
            statusLog.classList.add('hidden');
            statusLog.innerHTML = '';

            // Styling for active state
            const activeClass = ['border-2', 'border-mitratel-red', 'bg-red-50', 'dark:bg-red-900/10', 'text-mitratel-red', 'font-semibold'];
            const inactiveClass = ['border', 'border-gray-200', 'dark:border-gray-700', 'text-gray-500', 'dark:text-gray-400'];

            if (mode === 'excel') {
                modeExcelBtn.classList.add(...activeClass);
                modeExcelBtn.classList.remove(...inactiveClass);
                modeTextBtn.classList.remove(...activeClass);
                modeTextBtn.classList.add(...inactiveClass);
                
                fileInput.accept = ".xlsx, .xls";
                acceptText.innerText = "Accepts multiple .xlsx files";
                dropIcon.className = "fa-solid fa-file-excel text-4xl text-emerald-500 mb-3 transition-colors";
            } else {
                modeTextBtn.classList.add(...activeClass);
                modeTextBtn.classList.remove(...inactiveClass);
                modeExcelBtn.classList.remove(...activeClass);
                modeExcelBtn.classList.add(...inactiveClass);

                fileInput.accept = ".txt, .tsv, .csv";
                acceptText.innerText = "Accepts multiple .txt files";
                dropIcon.className = "fa-solid fa-file-lines text-4xl text-slate-400 mb-3 transition-colors";
            }
        }

        // --- Existing UI Logic ---

        // Toggle Filename Input based on mode
        modeInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                if(e.target.value === 'merge') {
                    filenameContainer.classList.remove('opacity-50', 'pointer-events-none');
                    customFilenameInput.disabled = false;
                } else {
                    filenameContainer.classList.add('opacity-50', 'pointer-events-none');
                    customFilenameInput.disabled = true;
                    customFilenameInput.value = ''; // Clear when disabled
                }
            });
        });

        // Drag & Drop Effects
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleSelect, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const newFiles = dt.files;
            handleFiles(newFiles);
        }

        function handleSelect(e) {
            const newFiles = e.target.files;
            handleFiles(newFiles);
        }

        function handleFiles(files) {
            if (!files.length) return;
            filesToProcess = [...filesToProcess, ...Array.from(files)];
            updateUI();
        }

        function updateUI() {
            fileList.innerHTML = '';
            fileCountSpan.textContent = filesToProcess.length;

            if (filesToProcess.length > 0) {
                fileListContainer.classList.remove('hidden');
                convertBtn.disabled = false;
                
                filesToProcess.forEach((file, index) => {
                    const size = (file.size / 1024).toFixed(1) + ' KB';
                    const iconClass = currentInputMode === 'excel' ? 'fa-file-excel text-emerald-500' : 'fa-file-lines text-slate-500';
                    const bgClass = currentInputMode === 'excel' ? 'bg-emerald-50 dark:bg-emerald-900/20' : 'bg-slate-100 dark:bg-slate-800';
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-white dark:bg-gray-900 p-3 rounded-xl border border-gray-100 dark:border-gray-700 group hover:border-mitratel-red/30 transition-colors';
                    div.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded-lg ${bgClass} flex items-center justify-center ${iconClass} flex-shrink-0">
                                <i class="fa-regular ${iconClass.split(' ')[0]}"></i>
                            </div>
                            <div class="truncate">
                                <p class="font-medium text-slate-700 dark:text-gray-200 truncate text-sm" title="${file.name}">${file.name}</p>
                                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">${size}</p>
                            </div>
                        </div>
                        <button onclick="removeFile(${index})" class="w-8 h-8 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-500 transition flex items-center justify-center">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    `;
                    fileList.appendChild(div);
                });
            } else {
                fileListContainer.classList.add('hidden');
                convertBtn.disabled = true;
            }
        }

        window.removeFile = (index) => {
            filesToProcess.splice(index, 1);
            updateUI();
        }

        clearBtn.addEventListener('click', () => {
            filesToProcess = [];
            updateUI();
            statusLog.classList.add('hidden');
            statusLog.innerHTML = '';
        });

        // --- Logic Helper ---

        function getProjectID(filename) {
            // Regex for pattern like 22IS12T0097 or 25UM11T2514
            const regex = /\b\d{2}[A-Z]{2}\d{2}[A-Z]\d{4}\b/i;
            const match = filename.match(regex);
            if (match) return match[0];
            return filename.replace(/\.[^/.]+$/, "");
        }

        function triggerDownload(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function log(msg, type = 'info') {
            statusLog.classList.remove('hidden');
            const color = type === 'error' ? 'text-red-600' : (type === 'success' ? 'text-emerald-600' : 'text-slate-600 dark:text-gray-400');
            const div = document.createElement('div');
            div.className = `${color} mb-1 flex items-start gap-2`;
            div.innerHTML = `<span class="opacity-50 select-none">></span> <span>${msg}</span>`;
            statusLog.appendChild(div);
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        // --- Data Processors ---

        async function processExcelFile(file) {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            
            let sheetName = "below_ring";
            if (!workbook.SheetNames.includes(sheetName)) {
                sheetName = workbook.SheetNames[0];
                log(`  Warning: "below_ring" not found in ${file.name}. Using "${sheetName}".`, 'info');
            }

            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
            
            if (!jsonData || jsonData.length === 0) return null;
            return jsonData; // Returns Array of Arrays
        }

        async function processTextFile(file) {
            const text = await file.text();
            // Split by newline, filter out empty lines at the end if any
            const lines = text.split(/\r?\n/);
            // We want to return raw lines, but filter out pure empty string lines to avoid gaps
            const validLines = lines.filter(line => line.trim() !== "");
            
            if (validLines.length === 0) return null;
            return validLines; // Returns Array of Strings
        }

        // --- Main Convert Handler ---

        convertBtn.addEventListener('click', async () => {
            const mode = document.querySelector('input[name="outputMode"]:checked').value;
            convertBtn.disabled = true;
            convertBtn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...`;
            statusLog.innerHTML = '';

            try {
                if (mode === 'merge') {
                    await processMergeMode();
                } else {
                    await processSeparateMode();
                }
            } catch (error) {
                log(`Critical Error: ${error.message}`, 'error');
            } finally {
                convertBtn.disabled = false;
                convertBtn.innerHTML = `<span>Run Conversion</span> <i class="fa-solid fa-arrow-right"></i>`;
            }
        });

        async function processMergeMode() {
            let combinedData = [];
            let headers = null; // For Excel
            let headerLine = null; // For Text
            let outputFilename = "batch_output.txt";

            // Check Custom Filename
            const customName = customFilenameInput.value.trim();
            
            for (let i = 0; i < filesToProcess.length; i++) {
                const file = filesToProcess[i];
                const isFirstFile = (i === 0);

                // Filename logic
                if (isFirstFile) {
                    if (customName) {
                        outputFilename = customName;
                        if (!outputFilename.toLowerCase().endsWith('.txt')) {
                            outputFilename += '.txt';
                        }
                    } else {
                        const extractedID = getProjectID(file.name);
                        outputFilename = extractedID + "_merged.txt";
                    }
                }

                log(`Processing: ${file.name}...`);

                try {
                    if (currentInputMode === 'excel') {
                        // --- EXCEL MERGE LOGIC ---
                        const jsonData = await processExcelFile(file);
                        if (!jsonData) { log(`  Skipping: Empty data.`, 'error'); continue; }

                        const currentHeaders = jsonData[0];
                        const rows = jsonData.slice(1);

                        // Capture header from first file
                        if (isFirstFile) {
                            headers = currentHeaders;
                            combinedData.push(headers.join('\t')); 
                        }

                        // Append rows
                        rows.forEach(row => {
                            const tsvRow = row.map(cell => {
                                if (cell === null || cell === undefined) return '';
                                return String(cell).replace(/\t/g, ' ');
                            }).join('\t');
                            if(tsvRow.trim() !== "") combinedData.push(tsvRow);
                        });

                    } else {
                        // --- TEXT MERGE LOGIC ---
                        const lines = await processTextFile(file);
                        if (!lines) { log(`  Skipping: Empty file.`, 'error'); continue; }

                        if (isFirstFile) {
                            // Keep everything (Header + Body)
                            headerLine = lines[0]; // Remember header for safety if needed
                            combinedData.push(...lines);
                        } else {
                            // Skip first line (Header), keep Body
                            if (lines.length > 1) {
                                combinedData.push(...lines.slice(1));
                            }
                        }
                    }

                } catch (err) {
                    log(`  Error: ${err.message}`, 'error');
                }
            }

            if (combinedData.length === 0) throw new Error("No data extracted.");
            
            const finalContent = combinedData.join('\r\n');
            triggerDownload(finalContent, outputFilename);
            log(`Done! Merged ${filesToProcess.length} files into ${outputFilename}`, 'success');
        }

        async function processSeparateMode() {
            let processedCount = 0;

            for (let i = 0; i < filesToProcess.length; i++) {
                const file = filesToProcess[i];
                log(`Processing: ${file.name}...`);
                
                try {
                    const extractedID = getProjectID(file.name);
                    const outputFilename = extractedID + ".txt";
                    let finalContent = "";

                    if (currentInputMode === 'excel') {
                        const jsonData = await processExcelFile(file);
                        if (!jsonData) continue;

                        const rows = jsonData.map(row => {
                             return row.map(cell => {
                                if (cell === null || cell === undefined) return '';
                                return String(cell).replace(/\t/g, ' ');
                            }).join('\t');
                        });
                        finalContent = rows.join('\r\n');

                    } else {
                        // For Text separate mode, basically just reading and resaving 
                        // (useful if they want to standardize filenames or line endings)
                        const lines = await processTextFile(file);
                        if (!lines) continue;
                        finalContent = lines.join('\r\n');
                    }

                    // Add slight delay
                    await new Promise(r => setTimeout(r, 200));
                    triggerDownload(finalContent, outputFilename);
                    processedCount++;

                } catch (err) {
                    log(`  Error: ${err.message}`, 'error');
                }
            }
            log(`Done! Processed ${processedCount} files separately.`, 'success');
        }
})();
</script>
</body>
</html>
